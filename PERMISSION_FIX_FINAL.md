# æƒé™æ£€æŸ¥é—®é¢˜æœ€ç»ˆä¿®å¤æ–¹æ¡ˆ

## é—®é¢˜åˆ†æ

### åŸå§‹é—®é¢˜
é¡µé¢æ²¡æœ‰æ˜¾ç¤ºæ— æƒé™æç¤ºï¼Œå³ä½¿åç«¯å·²ç»æ£€æŸ¥åˆ° `isView=false`ã€‚

### æ ¹æœ¬åŸå› 

1. **åç«¯è¿”å›æ ¼å¼é—®é¢˜**ï¼š
   - SearchService æ£€æŸ¥åˆ°æƒé™è¢«æ‹’ç»æ—¶ï¼Œè¿”å›çš„æ˜¯ç©ºç»“æœï¼ˆtotal=0ï¼‰ä½† `success=true`
   - Controller æ²¡æœ‰å°†æƒé™æ‹’ç»è½¬æ¢ä¸º `success=false`
   - å‰ç«¯åªæ£€æŸ¥ `success` å­—æ®µï¼Œæ²¡æœ‰æ£€æŸ¥ `filterMessage`

2. **è¡¨å•åˆ—è¡¨æ¥å£é—®é¢˜**ï¼š
   - `getFormDocumentStatsWithPermission()` è¿”å›ç©ºåˆ—è¡¨ï¼Œè€Œä¸æ˜¯æŠ›å‡ºå¼‚å¸¸
   - Controller ä»ç„¶è¿”å› `success=true` å’Œç©ºæ•°æ®
   - å‰ç«¯è®¤ä¸ºè¯·æ±‚æˆåŠŸï¼Œåªæ˜¯æ²¡æœ‰æ•°æ®

## ä¿®å¤æ–¹æ¡ˆ

### ä¿®æ”¹1: è¡¨å•åˆ—è¡¨æ¥å£æŠ›å‡ºå¼‚å¸¸

**æ–‡ä»¶**: `SearchService.java` (ç¬¬610-612è¡Œ)

```java
// ä¿®æ”¹å‰
if (filterResult.isDenyAll()) {
    return new ArrayList<>();
}

// ä¿®æ”¹å
if (filterResult.isDenyAll()) {
    log.warn("ç”¨æˆ· {} æƒé™è¢«æ‹’ç»ï¼ŒåŸå› : {}", userIdStr, filterResult.getMessage());
    throw new IllegalStateException(filterResult.getMessage());
}
```

**æ•ˆæœ**: æƒé™è¢«æ‹’ç»æ—¶æŠ›å‡ºå¼‚å¸¸ï¼ŒControllerçš„ catch å—ä¼šæ•è·å¹¶è¿”å› `success=false`

### ä¿®æ”¹2: æœç´¢æ¥å£è¿”å›å¤±è´¥çŠ¶æ€

**æ–‡ä»¶**: `SearchController.java` (ç¬¬61-74è¡Œ)

```java
// æ–°å¢ä»£ç 
// æ£€æŸ¥æ˜¯å¦æ˜¯æƒé™è¢«æ‹’ç»
boolean isPermissionDenied = result.getTotal() == 0 
    && StringUtils.isNotBlank(result.getFilterMessage())
    && (result.getFilterMessage().contains("æ²¡æœ‰æƒé™") 
        || result.getFilterMessage().contains("æ— æƒé™")
        || result.getFilterMessage().contains("æƒé™ä¸è¶³"));

if (isPermissionDenied) {
    // æƒé™è¢«æ‹’ç»ï¼Œè¿”å›å¤±è´¥å“åº”
    Map<String, Object> response = new HashMap<>();
    response.put("success", false);
    response.put("message", result.getFilterMessage());
    return ResponseEntity.ok(response);
}
```

**æ•ˆæœ**: æƒé™è¢«æ‹’ç»æ—¶ï¼Œæ˜ç¡®è¿”å› `success: false`ï¼Œå‰ç«¯å¯ä»¥æ­£ç¡®è¯†åˆ«

### ä¿®æ”¹3: å‰ç«¯æ— æƒé™æç¤º

**æ–‡ä»¶**: `index.html` (ç¬¬1203-1214è¡Œ)

å‰ç«¯å·²ç»å®ç°äº†æ— æƒé™æç¤ºçš„UIï¼Œå½“æ£€æµ‹åˆ°æƒé™ç›¸å…³çš„é”™è¯¯æ¶ˆæ¯æ—¶ï¼Œæ˜¾ç¤ºå‹å¥½çš„æç¤ºé¡µé¢ã€‚

## å®Œæ•´æµç¨‹

### æœ‰æƒé™çš„ç”¨æˆ· (isView=true)

```
1. å‰ç«¯å‘é€è¯·æ±‚ â†’ 
2. åç«¯æ£€æŸ¥æƒé™ (isView=true) â†’ 
3. å…è®¸è®¿é—® â†’ 
4. è¿”å› {success: true, data: [...]} â†’ 
5. å‰ç«¯æ­£å¸¸æ˜¾ç¤ºæ•°æ®
```

### æ— æƒé™çš„ç”¨æˆ· (isView=false)

```
1. å‰ç«¯å‘é€è¯·æ±‚ â†’ 
2. åç«¯æ£€æŸ¥æƒé™ (isView=false) â†’ 
3. æ‹’ç»è®¿é—® â†’ 
4. è¿”å› {success: false, message: "æ‚¨æ²¡æœ‰æƒé™è®¿é—®ï¼Œè¯·è”ç³»ç®¡ç†å‘˜"} â†’ 
5. å‰ç«¯æ˜¾ç¤ºæ— æƒé™æç¤ºé¡µé¢ ğŸ”’
```

## æµ‹è¯•éªŒè¯

### 1. è¡¨å•åˆ—è¡¨åŠ è½½æµ‹è¯•

**è¯·æ±‚**:
```bash
curl "http://localhost:8088/api/search/forms?userId=-64557199688994460741"
```

**é¢„æœŸå“åº”** (æ— æƒé™):
```json
{
  "success": false,
  "message": "æ‚¨æ²¡æœ‰æƒé™è®¿é—®ï¼Œè¯·è”ç³»ç®¡ç†å‘˜"
}
```

**å‰ç«¯æ•ˆæœ**:
- è¡¨å•è¿‡æ»¤åŒºåŸŸæ˜¾ç¤ºé»„è‰²è­¦å‘Šæ¡†
- æ˜¾ç¤º ğŸ”’ å›¾æ ‡å’Œ"æ— æƒé™è®¿é—®"æç¤º
- ä¸æ˜¾ç¤ºä»»ä½•æ•°æ®æº

### 2. æœç´¢æ¥å£æµ‹è¯•

**è¯·æ±‚**:
```bash
curl -X POST http://localhost:8088/api/search/search \
  -H "Content-Type: application/json" \
  -d '{
    "query": "æµ‹è¯•",
    "userId": "-64557199688994460741",
    "size": 10,
    "from": 0
  }'
```

**é¢„æœŸå“åº”** (æ— æƒé™):
```json
{
  "success": false,
  "message": "æ‚¨æ²¡æœ‰æƒé™è®¿é—®ï¼Œè¯·è”ç³»ç®¡ç†å‘˜"
}
```

**å‰ç«¯æ•ˆæœ**:
- æœç´¢ç»“æœåŒºåŸŸæ˜¾ç¤ºå¤§çš„æ— æƒé™æç¤ºé¡µé¢
- æ˜¾ç¤º ğŸ”’ å›¾æ ‡ï¼ˆ72pxå¤§ï¼‰
- çº¢è‰²æ ‡é¢˜ï¼š"æ— æƒé™è®¿é—®"
- é”™è¯¯æ¶ˆæ¯å’Œè§£å†³å»ºè®®

### 3. åç«¯æ—¥å¿—éªŒè¯

æ‰§è¡Œæœç´¢æ“ä½œåï¼Œåº”è¯¥çœ‹åˆ°ä»¥ä¸‹æ—¥å¿—ï¼š

```
ç”¨æˆ·æƒé™æ£€æŸ¥ç»“æœ: userId=-64557199688994460741, isAdmin=false, isView=false (isViewObj=false)
ç”¨æˆ· -64557199688994460741 æ²¡æœ‰æŸ¥çœ‹æƒé™ï¼ŒisView=false
ç”¨æˆ· -64557199688994460741 æƒé™è¢«æ‹’ç»ï¼ŒåŸå› : æ‚¨æ²¡æœ‰æƒé™è®¿é—®ï¼Œè¯·è”ç³»ç®¡ç†å‘˜
```

## å…³é”®ä¿®æ”¹ç‚¹æ€»ç»“

| ä½ç½® | ä¿®æ”¹å†…å®¹ | ç›®çš„ |
|------|---------|------|
| SearchService.java:612 | æƒé™æ‹’ç»æ—¶æŠ›å‡ºå¼‚å¸¸ | è®©Controllerè¿”å›å¤±è´¥çŠ¶æ€ |
| SearchController.java:61-74 | æ£€æŸ¥æƒé™æ‹’ç»å¹¶è¿”å›success=false | å‰ç«¯èƒ½æ­£ç¡®è¯†åˆ«æƒé™é—®é¢˜ |
| index.html:1203-1214 | æ— æƒé™æç¤ºUI | å‹å¥½çš„è§†è§‰æç¤º |
| index.html:904-921 | è¡¨å•åˆ—è¡¨æ— æƒé™æç¤º | æ•°æ®æºåˆ—è¡¨åŒºåŸŸçš„æç¤º |

## éƒ¨ç½²æ­¥éª¤

1. **ç¼–è¯‘é¡¹ç›®**:
```bash
mvn clean package -DskipTests
```

2. **é‡å¯åº”ç”¨**:
```bash
# åœæ­¢æ—§åº”ç”¨
kill -9 $(ps aux | grep 'es_admin' | awk '{print $2}')

# å¯åŠ¨æ–°åº”ç”¨
nohup java -jar target/es_admin-*.jar > logs/app.log 2>&1 &
```

3. **éªŒè¯åŠŸèƒ½**:
```bash
# æµ‹è¯•æƒé™æ£€æŸ¥
curl http://localhost:8088/api/search/permission/check/-64557199688994460741

# æµ‹è¯•è¡¨å•åˆ—è¡¨
curl "http://localhost:8088/api/search/forms?userId=-64557199688994460741"
```

4. **æ¸…ç†æµè§ˆå™¨ç¼“å­˜**:
- æŒ‰ Ctrl+Shift+Delete
- æ¸…é™¤ç¼“å­˜å’ŒCookie
- åˆ·æ–°é¡µé¢ (Ctrl+F5)

## æ³¨æ„äº‹é¡¹

### ç®¡ç†å‘˜æ¥å£è¦æ±‚

ç®¡ç†å‘˜æ¥å£å¿…é¡»è¿”å›æ­£ç¡®çš„ `isView` å­—æ®µï¼š

```json
{
  "code": 200,
  "message": "success",
  "data": {
    "isAdmin": false,
    "isView": false    // å…³é”®å­—æ®µ
  }
}
```

å¦‚æœæ¥å£è¿”å›ï¼š
- `isView=null`: é»˜è®¤å½“ä½œ `true`ï¼ˆæœ‰æƒé™ï¼‰
- `isView=false`: æ— æƒé™
- `isView=true`: æœ‰æƒé™

### é»˜è®¤å€¼è¯´æ˜

å½“å‰é…ç½®ï¼š
- æ¥å£è¿”å›nullæ—¶ï¼Œé»˜è®¤ `isView=true`ï¼ˆæœ‰æƒé™ï¼‰
- è¿™æ˜¯ä¸ºäº†å…¼å®¹è€ç‰ˆæœ¬æ¥å£

å¦‚æœéœ€è¦æ›´ä¸¥æ ¼çš„æ§åˆ¶ï¼ˆnullä¹Ÿå½“ä½œæ— æƒé™ï¼‰ï¼Œä¿®æ”¹ï¼š

```java
// AdminCheckService.java:112
// å½“å‰ä»£ç 
boolean isView = isViewObj != null ? isViewObj : true;

// æ”¹ä¸ºæ›´ä¸¥æ ¼
boolean isView = Boolean.TRUE.equals(isViewObj);
```

## æ•…éšœæ’æŸ¥

### é—®é¢˜: é‡å¯åè¿˜æ˜¯æ˜¾ç¤ºæ­£å¸¸é¡µé¢

**æ£€æŸ¥é¡¹**:
1. ç¡®è®¤ä»£ç å·²é‡æ–°ç¼–è¯‘
2. æ¸…é™¤æµè§ˆå™¨ç¼“å­˜
3. æ£€æŸ¥ç®¡ç†å‘˜æ¥å£è¿”å›å€¼
4. æŸ¥çœ‹åç«¯æ—¥å¿—

**è°ƒè¯•å‘½ä»¤**:
```bash
# æŸ¥çœ‹å®æ—¶æ—¥å¿—
tail -f logs/application.log | grep -E "æƒé™æ£€æŸ¥|isView|æ²¡æœ‰æƒé™"

# æµ‹è¯•æ¥å£
curl http://localhost:8088/api/search/permission/check/YOUR_USER_ID
```

### é—®é¢˜: æœ‰æƒé™çš„ç”¨æˆ·ä¹Ÿè¢«æ‹’ç»

**å¯èƒ½åŸå› **:
- ç®¡ç†å‘˜æ¥å£è¿”å› `isView=null`
- é»˜è®¤å€¼é€»è¾‘æ”¹ä¸ºäº†æ›´ä¸¥æ ¼çš„æ¨¡å¼

**è§£å†³æ–¹æ¡ˆ**:
ç¡®ä¿ç®¡ç†å‘˜æ¥å£æ­£ç¡®è¿”å› `isView=true`

## æ€»ç»“

é€šè¿‡è¿™æ¬¡ä¿®å¤ï¼š
1. âœ… æƒé™æ£€æŸ¥é€»è¾‘æ­£ç¡®æ‰§è¡Œ
2. âœ… åç«¯æ­£ç¡®è¿”å›æƒé™æ‹’ç»çŠ¶æ€
3. âœ… å‰ç«¯æ­£ç¡®æ˜¾ç¤ºæ— æƒé™æç¤º
4. âœ… ç”¨æˆ·ä½“éªŒå¾—åˆ°æ”¹å–„

ç°åœ¨æ— æƒé™ç”¨æˆ·è®¿é—®ç³»ç»Ÿæ—¶ï¼Œä¼šçœ‹åˆ°æ¸…æ™°æ˜ç¡®çš„æç¤ºä¿¡æ¯ï¼Œè€Œä¸æ˜¯ç©ºç™½é¡µé¢æˆ–ç©ºåˆ—è¡¨ã€‚
