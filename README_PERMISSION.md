# 数据源部门权限管理功能

## 功能概述

该功能允许管理员配置哪些部门可以访问特定的数据源（包括表单和Excel导入的数据），实现细粒度的权限控制。默认情况下，所有部门都可以访问所有数据源，当配置了特定权限后，只有被授权的部门才能访问相应数据源。

**支持的数据源类型：**
- **表单数据** - CAP_FORM_DEFINITION表中的表单
- **Excel数据** - 通过Excel/CSV导入的数据源

## 数据库设计

### 数据源部门权限关联表 (FORM_DEPARTMENT_PERMISSION)

主要字段：
- `ID`: 主键
- `SOURCE_TYPE`: 数据源类型（'form'=表单，'excel'=Excel导入）
- `SOURCE_ID`: 数据源ID（表单ID或Excel表名）
- `SOURCE_NAME`: 数据源名称（表单名称或Excel显示名称）
- `DEPARTMENT_ID`: 部门ID，关联ORG_UNIT表中type='Department'的记录
- `DEPARTMENT_NAME`: 部门名称（冗余字段，便于查询）
- `PERMISSION_TYPE`: 权限类型（默认为'read'）
- `IS_ACTIVE`: 是否启用（1=启用，0=禁用）
- `CREATE_TIME`: 创建时间
- `UPDATE_TIME`: 更新时间
- `CREATOR_ID`: 创建者ID
- `REMARK`: 备注信息

### 组织结构表 (ORG_UNIT)

使用已有的ORG_UNIT表，通过`TYPE='Department'`筛选部门数据。

## API接口

### 1. 获取所有数据源权限配置
```
GET /api/form-department-permission/list
```

### 2. 获取所有部门列表
```
GET /api/form-department-permission/departments
```

### 3. 获取指定数据源的权限配置
```
GET /api/form-department-permission/source/{sourceType}/{sourceId}
```

### 4. 保存数据源权限配置
```
POST /api/form-department-permission/save
Content-Type: application/json

{
    "sourceType": "form",  // 或 "excel"
    "sourceId": "123456789",  // 表单ID或Excel表名
    "departmentIds": [1000001, 1000002],
    "creatorId": -6455719968899446074
}
```

### 5. 检查权限
```
GET /api/form-department-permission/check/{sourceType}/{sourceId}/{departmentId}
```

### 6. 删除数据源权限配置
```
DELETE /api/form-department-permission/source/{sourceType}/{sourceId}
```

### 7. 搜索权限配置
```
GET /api/form-department-permission/search?keyword=关键词
```

## 前端功能

### 部门权限管理页面

位置：主页面的"部门权限管理"标签页（仅管理员可见）

功能特性：
1. **数据源列表展示**：显示所有数据源（表单和Excel）及其当前权限状态
2. **数据源类型标识**：
   - 蓝色标签：表单数据源
   - 黄色标签：Excel数据源
3. **权限状态标识**：
   - 绿色标签：所有部门可访问
   - 黄色标签：限制部门访问
4. **搜索功能**：支持按数据源名称和部门名称搜索
5. **权限编辑**：通过模态框配置每个数据源的部门访问权限
6. **批量操作**：支持移除权限限制

### 权限配置模态框

- **访问模式选择**：
  - 所有部门都可以访问（默认）
  - 仅指定部门可以访问
- **部门选择器**：
  - 支持多选部门
  - 提供全选/清空快捷操作
  - 部门列表按排序ID和名称排序

## 权限控制逻辑

### 默认策略
- 如果数据源没有配置任何权限记录，则**所有部门**都可以访问
- 只有当明确配置了特定部门权限时，才启用访问限制
- 表单和Excel数据源使用相同的权限控制逻辑

### 权限检查流程
1. 查询数据源（通过sourceType和sourceId）是否存在任何权限配置记录
2. 如果不存在配置记录，返回true（允许访问）
3. 如果存在配置记录，检查用户所在部门是否在允许列表中
4. 返回检查结果

### 部门获取
从ORG_UNIT表中获取所有`TYPE='Department'`且`IS_DELETED=0`的记录。

## 安装部署

### 自动部署（推荐）
系统会在启动时自动检查并创建必要的数据库表，无需手动操作：

1. **自动表初始化**：应用启动时会检查`form_department_permission`表是否存在
2. **自动创建**：如果表不存在，系统会自动创建表和相关索引
3. **兼容性强**：支持达梦数据库和其他主流数据库
4. **日志记录**：初始化过程会记录详细日志便于排查问题

### 手动部署（可选）
如果需要手动创建表，可以执行SQL脚本：
```bash
# 连接到达梦数据库
# 执行 sql/create_form_department_permission.sql 文件
```

### 验证功能
1. **启动应用**：重启Java应用，查看日志确认表创建成功
2. **登录测试**：使用管理员账号登录系统
3. **功能验证**：切换到"部门权限管理"标签页
4. **权限测试**：验证能否正常加载数据源列表和部门列表
5. **配置测试**：测试权限配置和保存功能

## 使用说明

### 为数据源配置访问权限

1. 登录系统（需要管理员权限）
2. 进入"部门权限管理"页面
3. 找到要配置的数据源（表单或Excel），点击"编辑权限"
4. 选择"仅指定部门可以访问"
5. 勾选允许访问的部门
6. 点击"保存"

### 取消权限限制

1. 找到已配置限制的数据源（显示黄色"限制部门访问"标签）
2. 点击"移除限制"按钮
3. 确认操作

### 搜索和筛选

- 在搜索框中输入数据源名称或部门名称
- 系统会实时过滤显示匹配的记录
- 支持搜索表单和Excel数据源

## 注意事项

1. **管理员权限**：只有管理员用户可以看到和使用此功能
2. **默认开放**：新数据源（表单和Excel）默认对所有部门开放，需要手动配置限制
3. **数据一致性**：删除数据源或部门时，相关权限记录会保留但失效
4. **Excel支持**：Excel导入的数据源自动集成到权限管理系统中
5. **性能考虑**：权限检查查询已优化，使用了适当的索引
6. **备份建议**：配置重要权限前建议备份相关数据表

## 扩展功能

后续可以考虑的扩展：
1. 支持更细粒度的权限（只读、读写、管理员）
2. 支持权限继承（部门层级权限）
3. 权限变更日志记录
4. 批量导入/导出权限配置
5. 权限模板功能