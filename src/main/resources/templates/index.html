<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ESæ•°æ®ç®¡ç†ç³»ç»Ÿ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: #f5f5f5;
            color: #333;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .header {
            background: #fff;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .header h1 {
            color: #2c3e50;
            margin-bottom: 10px;
        }
        
        .tabs {
            display: flex;
            margin-bottom: 20px;
        }
        
        .tab {
            padding: 10px 20px;
            background: #fff;
            border: 1px solid #ddd;
            cursor: pointer;
            margin-right: 5px;
            border-radius: 4px 4px 0 0;
        }
        
        .tab.active {
            background: #007bff;
            color: white;
            border-color: #007bff;
        }
        
        .tab-content {
            display: none;
            background: #fff;
            padding: 20px;
            border-radius: 0 8px 8px 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .tab-content.active {
            display: block;
        }
        
        .search-section {
            margin-bottom: 30px;
        }
        
        .search-box {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .form-filter-section {
            background: #fff;
            border: 1px solid #e9ecef;
            border-radius: 6px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .form-filter-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            font-size: 14px;
            color: #555;
        }

        .form-filter-header label {
            display: flex;
            align-items: center;
            gap: 6px;
            cursor: pointer;
        }

        .form-filter-summary {
            font-size: 12px;
            color: #888;
        }

        .form-filter-list {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            max-height: 200px;
            overflow-y: auto;
        }

        .form-filter-item {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 4px;
            padding: 6px 10px;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .form-filter-badge {
            display: inline-flex;
            align-items: center;
            padding: 0 6px;
            border-radius: 3px;
            background: #e6f0ff;
            color: #2254b3;
            font-size: 12px;
        }

        .form-filter-item[data-type="excel"] .form-filter-badge {
            background: #fff3cd;
            color: #8a6200;
        }

        .form-filter-count {
            color: #888;
            font-size: 12px;
        }
        
        .search-input {
            flex: 1;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 16px;
        }
        
        .search-btn, .sync-btn {
            padding: 12px 24px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
        }
        
        .search-btn:hover, .sync-btn:hover {
            background: #0056b3;
        }
        
        .search-btn:disabled, .sync-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        
        .results {
            margin-top: 20px;
        }
        
        .result-item {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 4px;
            padding: 15px;
            margin-bottom: 10px;
        }
        
        .result-header {
            display: flex;
            justify-content: between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .result-title {
            font-weight: bold;
            color: #007bff;
        }
        
        .result-score {
            font-size: 12px;
            color: #666;
        }
        
        .result-meta {
            font-size: 12px;
            color: #666;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .result-content {
            background: white;
            padding: 10px;
            border-radius: 4px;
            border: 1px solid #e9ecef;
        }
        
        .highlight {
            background: yellow;
            padding: 2px 4px;
            border-radius: 2px;
        }
        
        .sync-section {
            margin-bottom: 30px;
        }
        
        .forms-list {
            margin-top: 20px;
        }
        
        .form-item {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 4px;
            padding: 15px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .form-info h4 {
            margin-bottom: 5px;
        }
        
        .form-info .form-meta {
            font-size: 12px;
            color: #666;
        }
        
        .form-actions {
            display: flex;
            gap: 10px;
        }
        
        .btn-small {
            padding: 6px 12px;
            font-size: 14px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        
        .btn-primary {
            background: #007bff;
            color: white;
        }
        
        .btn-success {
            background: #28a745;
            color: white;
        }
        
        .btn-primary:hover {
            background: #0056b3;
        }
        
        .btn-success:hover {
            background: #1e7e34;
        }
        
        .btn-danger {
            background: #dc3545;
            color: white;
        }
        
        .btn-danger:hover {
            background: #c82333;
        }
        
        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }
        
        .error {
            background: #f8d7da;
            color: #721c24;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }

        .user-info {
            font-size: 14px;
            color: #555;
            margin-bottom: 10px;
        }

        .user-info strong {
            color: #007bff;
        }

        .success {
            background: #d4edda;
            color: #155724;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }

        .pagination {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 20px;
        }
        
        .page-btn {
            padding: 8px 12px;
            border: 1px solid #ddd;
            background: white;
            cursor: pointer;
            border-radius: 4px;
        }
        
        .page-btn:hover {
            background: #f8f9fa;
        }
        
        .page-btn.active {
            background: #007bff;
            color: white;
            border-color: #007bff;
        }
        
        .jump-link {
            color: #007bff;
            text-decoration: none;
            margin-left: 10px;
            font-size: 16px;
        }
        
        .jump-link:hover {
            color: #0056b3;
        }

        .dept-tree {
            list-style: none;
            padding-left: 12px;
            margin: 4px 0;
        }

        .dept-tree ul {
            list-style: none;
            padding-left: 16px;
            margin: 2px 0;
        }

        .dept-tree label {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 4px 0;
            font-size: 14px;
        }

        .dept-tree input[type="checkbox"] {
            margin: 0;
        }

        .dept-node {
            position: relative;
        }

        .dept-toggle {
            width: 16px;
            height: 16px;
            border: none;
            background: none;
            cursor: pointer;
            color: #007bff;
            padding: 0;
            font-size: 14px;
            margin-right: 4px;
        }

        .dept-toggle:focus {
            outline: none;
        }

        .dept-node.collapsed > ul {
            display: none;
        }
        
        .jump-btn {
            background: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 4px 8px;
            font-size: 11px;
            cursor: pointer;
        }
        
        .jump-btn:hover {
            background: #0056b3;
        }

        .permission-item {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 4px;
            padding: 15px;
            margin-bottom: 15px;
        }
        
        .permission-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .permission-form-name {
            font-weight: bold;
            font-size: 16px;
            color: #333;
        }
        
        .permission-status {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
        }
        
        .permission-status.all-access {
            background: #d4edda;
            color: #155724;
        }
        
        .permission-status.restricted {
            background: #fff3cd;
            color: #856404;
        }
        
        .department-list {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin: 10px 0;
        }
        
        .department-tag {
            background: #e6f0ff;
            color: #2254b3;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
        }
        
        .permission-actions {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }
        
        .modal-content {
            background-color: #fefefe;
            margin: 5% auto;
            padding: 20px;
            border-radius: 8px;
            width: 70%;
            max-width: 800px;
            max-height: 80%;
            overflow-y: auto;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }
        
        .modal-close {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #aaa;
        }
        
        .modal-close:hover {
            color: #000;
        }
        
        .department-selector {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 10px;
            margin: 10px 0;
        }
        
        .department-option {
            display: flex;
            align-items: center;
            padding: 8px;
            margin: 4px 0;
            border-radius: 4px;
        }
        
        .department-option:hover {
            background: #f8f9fa;
        }
        
        .department-option input[type="checkbox"] {
            margin-right: 8px;
        }
        
        .permission-mode-selector {
            margin: 15px 0;
        }
        
        .permission-mode-selector label {
            display: flex;
            align-items: center;
            gap: 8px;
            margin: 8px 0;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ESæ•°æ®ç®¡ç†ç³»ç»Ÿ</h1>
            <p>è¡¨å•æ•°æ®åŒæ­¥ä¸æœç´¢ç®¡ç†</p>
        </div>
        
        <div class="tabs">
            <div class="tab active" onclick="switchTab(event, 'search')">æ•°æ®æœç´¢</div>
            <div class="tab" onclick="switchTab(event, 'sync')">æ•°æ®åŒæ­¥</div>
            <div class="tab" onclick="switchTab(event, 'excel')">Excel/CSVå¯¼å…¥</div>
            <div class="tab" onclick="switchTab(event, 'review')">å®¡æ ¸ç­–ç•¥ç»´æŠ¤</div>
            <div class="tab" onclick="switchTab(event, 'permission')">éƒ¨é—¨æƒé™ç®¡ç†</div>
        </div>
        
        <!-- æœç´¢æ ‡ç­¾é¡µ -->
        <div id="search-tab" class="tab-content active">
            <div class="search-section">
                <h3>æ•°æ®æœç´¢</h3>
                <div class="search-box">
                    <input type="text" id="searchInput" class="search-input" placeholder="è¾“å…¥æœç´¢å…³é”®è¯ï¼Œå¦‚ï¼šå°å¼ç”µè„‘2">
                    <label style="display: flex; align-items: center; gap: 6px; font-size: 14px; color: #555;">
                        <input type="checkbox" id="exactSearchCheckbox">
                        ç²¾ç¡®æœç´¢
                    </label>
                    <button class="search-btn" onclick="performSearch()">æœç´¢</button>
                </div>
                <div id="userInfoNotice" class="user-info"></div>
                
                <div id="formFilters" class="form-filter-section">
                    <div class="form-filter-header">
                        <label>
                            <input type="checkbox" id="formFilterAll" checked>
                            å…¨éƒ¨è¡¨å•
                        </label>
                        <div>
                            <span id="formFilterSummary" class="form-filter-summary"></span>
                            <button class="btn-small btn-primary" onclick="refreshFormStats()" style="margin-left: 10px; font-size: 12px;">åˆ·æ–°</button>
                        </div>
                    </div>
                    <div class="form-filter-search" style="margin: 10px 0;">
                        <input type="text" id="formFilterSearch" class="search-input" placeholder="è¾“å…¥åç§°æœç´¢æ•°æ®æº..." style="font-size: 14px; padding: 8px;">
                    </div>
                    <div id="formFilterList" class="form-filter-list"></div>
                </div>
                
                <div id="searchResults" class="results"></div>
                <div id="pagination" class="pagination"></div>
            </div>
        </div>
        
        <!-- åŒæ­¥æ ‡ç­¾é¡µ -->
        <div id="sync-tab" class="tab-content">
            <div class="sync-section">
                <h3>æ•°æ®åŒæ­¥ç®¡ç†</h3>
                <div style="margin-bottom: 20px;">
                    <div class="search-box">
                        <input type="text" id="formSearchInput" class="search-input" placeholder="æœç´¢è¡¨å•åç§°...">
                        <button class="search-btn" onclick="searchForms()">æœç´¢</button>
                        <button class="sync-btn" onclick="loadForms(1)" style="margin-left: 10px;">åˆ·æ–°åˆ—è¡¨</button>
                        <!-- <button class="sync-btn" onclick="syncAllForms()" style="margin-left: 10px;">åŒæ­¥æ‰€æœ‰è¡¨å•</button> -->
                        <button class="sync-btn" onclick="asyncSyncAllForms()" style="margin-left: 10px;">å¼‚æ­¥åŒæ­¥æ‰€æœ‰è¡¨å•</button>
                    </div>
                </div>
                
                <!-- å¼‚æ­¥åŒæ­¥çŠ¶æ€æ˜¾ç¤º -->
                <div id="asyncSyncStatus" style="display: none; margin: 20px 0; padding: 15px; background: #f8f9fa; border-radius: 4px; border-left: 4px solid #007bff;">
                    <h4 style="margin: 0 0 10px 0;">å¼‚æ­¥åŒæ­¥è¿›åº¦</h4>
                    <div id="asyncSyncProgress">
                        <div style="background: #e9ecef; border-radius: 4px; height: 20px; margin: 10px 0;">
                            <div id="progressBar" style="background: #007bff; height: 100%; border-radius: 4px; width: 0%; transition: width 0.3s;"></div>
                        </div>
                        <div id="asyncSyncMessage">å‡†å¤‡ä¸­...</div>
                        <div id="asyncSyncDetails" style="font-size: 12px; color: #666; margin-top: 5px;"></div>
                    </div>
                </div>
                
                <div id="formsList" class="forms-list"></div>
                <div id="formsPagination" class="pagination"></div>
            </div>
        </div>

        <!-- Excel å¯¼å…¥æ ‡ç­¾é¡µ -->
        <div id="excel-tab" class="tab-content">
            <div class="sync-section">
                <h3>Excel/CSV æ•°æ®å¯¼å…¥</h3>
                <div class="search-box" style="flex-wrap: wrap; align-items: center;">
                    <input type="file" id="excelFileInput" accept=".xls,.xlsx,.csv" style="flex: 1 1 280px; background: #fff; padding: 10px; border: 1px solid #ddd; border-radius: 4px;">
                    <label style="display: flex; align-items: center; gap: 6px; font-size: 14px; color: #555;">
                        <input type="checkbox" id="excelCoverCheckbox">
                        è¦†ç›–åŒåè¡¨
                    </label>
                    <button class="sync-btn" type="button" onclick="uploadExcel()">ä¸Šä¼ å¹¶å¯¼å…¥</button>
                    <button class="sync-btn" type="button" onclick="loadExcelImports()" style="margin-left: 10px;">åˆ·æ–°è®°å½•</button>
                </div>
                <div id="excelImportMessage"></div>
                <div id="excelImportList" class="forms-list"></div>
            </div>
        </div>

        <!-- å®¡æ ¸ç­–ç•¥ç»´æŠ¤æ ‡ç­¾é¡µ -->
        <div id="review-tab" class="tab-content">
            <div class="sync-section">
                <h3>å®¡æ ¸ç­–ç•¥ç»´æŠ¤</h3>
                <div style="margin-bottom: 20px;">
                    <div class="search-box">
                        <input type="text" id="reviewSearchInput" class="search-input" placeholder="æœç´¢æ•°æ®æºåç§°...">
                        <button class="search-btn" onclick="searchReviewPolicies()">æœç´¢</button>
                        <button class="sync-btn" onclick="loadReviewPolicies()" style="margin-left: 10px;">åˆ·æ–°åˆ—è¡¨</button>
                    </div>
                    <div style="margin-top: 10px;">
                        <label style="display: flex; align-items: center; gap: 6px; font-size: 14px; color: #555;">
                            <input type="checkbox" id="reviewSelectAll" onchange="toggleAllReviewSelection()">
                            å…¨é€‰
                        </label>
                        <div style="margin-top: 10px; display: flex; gap: 10px;">
                            <button class="btn-small btn-primary" onclick="batchSetReviewMode('view_first')">æ‰¹é‡è®¾ç½®ä¸ºå…ˆçœ‹åå®¡</button>
                            <button class="btn-small btn-success" onclick="batchSetReviewMode('review_first')">æ‰¹é‡è®¾ç½®ä¸ºå…ˆå®¡åçœ‹</button>
                        </div>
                    </div>
                </div>
                
                <div id="reviewPoliciesList" class="forms-list"></div>
            </div>
        </div>

        <!-- éƒ¨é—¨æƒé™ç®¡ç†æ ‡ç­¾é¡µ -->
        <div id="permission-tab" class="tab-content">
            <div class="sync-section">
                <h3>éƒ¨é—¨æƒé™ç®¡ç†</h3>
                <div style="margin-bottom: 20px;">
                    <div class="search-box">
                        <input type="text" id="permissionSearchInput" class="search-input" placeholder="æœç´¢è¡¨å•åç§°...">
                        <button class="search-btn" onclick="searchFormPermissions()">æœç´¢</button>
                        <button class="sync-btn" onclick="loadFormPermissions()" style="margin-left: 10px;">åˆ·æ–°åˆ—è¡¨</button>
                    </div>
                </div>
                
                <div id="formPermissionsList" class="forms-list"></div>
            </div>
        </div>

        <!-- éƒ¨é—¨æƒé™é…ç½®æ¨¡æ€æ¡† -->
        <div id="permissionModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3 id="modalTitle">é…ç½®è¡¨å•éƒ¨é—¨æƒé™</h3>
                    <button class="modal-close" onclick="closePermissionModal()">&times;</button>
                </div>
                <div>
                    <div style="margin-bottom: 15px;">
                        <strong>è¡¨å•ï¼š</strong><span id="modalFormName"></span>
                    </div>
                    
                    <div class="permission-mode-selector">
                        <h4 style="margin-bottom: 10px;">è®¿é—®æƒé™æ¨¡å¼ï¼š</h4>
                        <label>
                            <input type="radio" name="accessMode" value="all" checked onchange="toggleAccessMode()">
                            æ‰€æœ‰éƒ¨é—¨éƒ½å¯ä»¥è®¿é—®ï¼ˆé»˜è®¤ï¼‰
                        </label>
                        <label>
                            <input type="radio" name="accessMode" value="restricted" onchange="toggleAccessMode()">
                            ä»…æŒ‡å®šéƒ¨é—¨å¯ä»¥è®¿é—®
                        </label>
                    </div>
                    
                    <div id="departmentSelection" style="display: none;">
                        <h4 style="margin: 15px 0 10px 0;">é€‰æ‹©å¯è®¿é—®çš„éƒ¨é—¨ï¼š</h4>
                        <div style="margin-bottom: 10px;">
                            <button class="btn-small btn-primary" onclick="selectAllDepartments()">å…¨é€‰</button>
                            <button class="btn-small" onclick="clearDepartmentSelection()" style="background: #6c757d; color: white;">æ¸…ç©º</button>
                        </div>
                        <div class="department-selector" id="departmentSelector">
                            <div class="loading">åŠ è½½éƒ¨é—¨åˆ—è¡¨...</div>
                        </div>
                    </div>
                    
                    <div style="margin-top: 20px; display: flex; gap: 10px; justify-content: flex-end;">
                        <button class="btn-small" onclick="closePermissionModal()" style="background: #6c757d; color: white;">å–æ¶ˆ</button>
                        <button class="btn-small btn-success" onclick="savePermissionConfig()">ä¿å­˜</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentPage = 0;
        let currentQuery = '';
        let currentFormsPage = 1;
        let currentFormsSearch = '';
        const pageSize = 10;
        let currentEventSource = null;
        let availableSearchForms = [];
        const selectedSearchFormIds = new Set();
        let currentUserId = '';
        const detailUrlConfig = { baseUrl: '' };
        let allReviewPolicies = [];
        let filteredReviewPolicies = [];
        function setDetailBaseUrl(raw) {
            if (!raw) {
                return;
            }
            detailUrlConfig.baseUrl = raw.endsWith('/') ? raw.slice(0, -1) : raw;
        }

        function buildDetailUrl(formId, recordId, fallbackUrl) {
            if (detailUrlConfig.baseUrl && formId && recordId && currentUserId && !String(formId).startsWith('excel:')) {
                return `${detailUrlConfig.baseUrl}/${formId}/${recordId}/${currentUserId}`;
            }
            return fallbackUrl || null;
        }

        function escapeForSingleQuotes(value) {
            return (value || '').replace(/'/g, "\\'");
        }

        async function initializeUserContext() {
            const params = new URLSearchParams(window.location.search || '');
            currentUserId = params.get('user_id') || params.get('userId') || params.get('userid') || '';

            const noticeEl = document.getElementById('userInfoNotice');
            if (!noticeEl) {
                return;
            }

            let isAdminUser = false;
            
            if (currentUserId) {
                try {
                    // è°ƒç”¨ç®¡ç†å‘˜æ£€æŸ¥API
                    const response = await fetch(`/api/search/admin/check/${encodeURIComponent(currentUserId)}`);
                    if (response.ok) {
                        const result = await response.json();
                        if (result.success && result.data) {
                            isAdminUser = result.data.isAdmin;
                        }
                    } else {
                        console.warn('ç®¡ç†å‘˜æƒé™æ£€æŸ¥å¤±è´¥:', response.status);
                    }
                } catch (error) {
                    console.warn('ç®¡ç†å‘˜æƒé™æ£€æŸ¥å‡ºé”™:', error);
                    // å¦‚æœAPIè°ƒç”¨å¤±è´¥ï¼Œfallbackåˆ°åŸæ¥çš„é€»è¾‘
                    const isAdmin = params.get('admin') === 'true';
                    isAdminUser = currentUserId === '-6455719968899446074' && isAdmin;
                }
                
                const adminBadge = isAdminUser ? ' <span style="background: #28a745; color: white; padding: 2px 6px; border-radius: 3px; font-size: 12px;">ç®¡ç†å‘˜</span>' : '';
                noticeEl.innerHTML = `å½“å‰ç”¨æˆ·: <strong>${currentUserId}</strong>${adminBadge}`;
            } else {
                noticeEl.innerHTML = '<div class="error" style="margin: 0;">ç¼ºå°‘ç”¨æˆ·IDï¼Œè¯·é€šè¿‡å¸¦æœ‰user_idå‚æ•°çš„é“¾æ¥è®¿é—®æœ¬é¡µé¢ã€‚</div>';
            }
            
            // æ˜¾ç¤ºæˆ–éšè—ç®¡ç†å‘˜æ ‡ç­¾é¡µ
            const syncTab = document.querySelector('.tab[onclick*="sync"]');
            const excelTab = document.querySelector('.tab[onclick*="excel"]');
            const reviewTab = document.querySelector('.tab[onclick*="review"]');
            const permissionTab = document.querySelector('.tab[onclick*="permission"]');
            
            if (syncTab) {
                syncTab.style.display = isAdminUser ? '' : 'none';
            }
            if (excelTab) {
                excelTab.style.display = isAdminUser ? '' : 'none';
            }
            if (reviewTab) {
                reviewTab.style.display = isAdminUser ? '' : 'none';
            }
            if (permissionTab) {
                permissionTab.style.display = isAdminUser ? '' : 'none';
            }
            
            // å¦‚æœå½“å‰æ¿€æ´»çš„æ ‡ç­¾é¡µè¢«éšè—äº†ï¼Œåˆ‡æ¢åˆ°æœç´¢æ ‡ç­¾é¡µ
            const activeTab = document.querySelector('.tab.active');
            if (activeTab && !isAdminUser && (
                activeTab.onclick.toString().includes('sync') || 
                activeTab.onclick.toString().includes('excel') ||
                activeTab.onclick.toString().includes('review') ||
                activeTab.onclick.toString().includes('permission')
            )) {
                // åˆ‡æ¢åˆ°æœç´¢æ ‡ç­¾é¡µ
                switchTab(null, 'search');
                // æ‰‹åŠ¨è®¾ç½®æ­£ç¡®çš„æ¿€æ´»çŠ¶æ€
                document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
                document.querySelector('.tab[onclick*="search"]').classList.add('active');
            }
        }

        // åˆ‡æ¢æ ‡ç­¾é¡µ
        function switchTab(e, tabName) {
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));

            const target = e ? (e.currentTarget || e.target) : null;
            if (target) {
                target.classList.add('active');
            }

            const tabContent = document.getElementById(tabName + '-tab');
            if (tabContent) {
                tabContent.classList.add('active');
            }

            if (tabName === 'sync') {
                loadForms(1);
            } else if (tabName === 'excel') {
                loadExcelImports();
            } else if (tabName === 'review') {
                loadReviewPolicies();
            } else if (tabName === 'permission') {
                loadFormPermissions();
            }
        }

        function loadSearchForms() {
            const listDiv = document.getElementById('formFilterList');
            const summarySpan = document.getElementById('formFilterSummary');
            if (!listDiv) {
                return;
            }

            listDiv.innerHTML = '<div class="loading">åŠ è½½è¡¨å•ä¿¡æ¯...</div>';
            if (summarySpan) {
                summarySpan.textContent = '';
            }

            const params = new URLSearchParams();
            if (currentUserId) {
                params.set('userId', currentUserId);
            }

            fetch('/api/search/forms' + (params.toString() ? `?${params.toString()}` : ''))
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        renderSearchFormFilters(data.data || []);
                    } else {
                        listDiv.innerHTML = `<div class="error">åŠ è½½è¡¨å•å¤±è´¥: ${data.message}</div>`;
                        if (summarySpan) {
                            summarySpan.textContent = 'æ•°æ®æºåˆ—è¡¨åŠ è½½å¤±è´¥';
                        }
                    }
                })
                .catch(error => {
                    console.error('åŠ è½½è¡¨å•å¤±è´¥', error);
                    listDiv.innerHTML = `<div class="error">åŠ è½½è¡¨å•å¤±è´¥: ${error.message}</div>`;
                    if (summarySpan) {
                        summarySpan.textContent = 'æ•°æ®æºåˆ—è¡¨åŠ è½½å¤±è´¥';
                    }
                });
        }

        function renderSearchFormFilters(forms) {
            const listDiv = document.getElementById('formFilterList');
            const allCheckbox = document.getElementById('formFilterAll');
            if (!listDiv) {
                return;
            }

            availableSearchForms = Array.isArray(forms) ? forms : [];
            selectedSearchFormIds.clear();

            if (availableSearchForms.length === 0) {
                listDiv.innerHTML = '<div class="loading">æœªæ‰¾åˆ°æ•°æ®æº</div>';
                if (allCheckbox) {
                    allCheckbox.checked = true;
                }
                updateFormFilterSummary();
                return;
            }

            // æ¸²æŸ“æ‰€æœ‰è¡¨å•é¡¹
            renderFilteredFormItems('');

            if (allCheckbox) {
                allCheckbox.checked = true;
            }
            updateFormFilterSummary();
        }

        function renderFilteredFormItems(searchText) {
            const listDiv = document.getElementById('formFilterList');
            const allCheckbox = document.getElementById('formFilterAll');
            if (!listDiv) {
                return;
            }

            const fragment = document.createDocumentFragment();
            const searchLower = searchText.toLowerCase();

            let visibleCount = 0;
            availableSearchForms.forEach(form => {
                if (!form || !form.id) {
                    return;
                }

                // è¿‡æ»¤é€»è¾‘
                if (searchText && !form.name.toLowerCase().includes(searchLower)) {
                    return;
                }
                visibleCount++;

                const itemLabel = document.createElement('label');
                itemLabel.className = 'form-filter-item';
                const typeValue = form.type || 'form';
                itemLabel.dataset.type = typeValue;
                if (form.index) {
                    itemLabel.title = `${form.name || ''} (ç´¢å¼•: ${form.index})`;
                }

                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.value = form.id;
                checkbox.checked = selectedSearchFormIds.has(form.id);

                checkbox.addEventListener('change', function(e) {
                    if (e.target.checked) {
                        selectedSearchFormIds.add(form.id);
                        if (allCheckbox) {
                            allCheckbox.checked = false;
                        }
                    } else {
                        selectedSearchFormIds.delete(form.id);
                        if (selectedSearchFormIds.size === 0 && allCheckbox) {
                            allCheckbox.checked = true;
                        }
                    }
                    updateFormFilterSummary();
                });

                const badgeSpan = document.createElement('span');
                badgeSpan.className = 'form-filter-badge';
                badgeSpan.textContent = typeValue === 'excel' ? 'Excel' : 'è¡¨å•';

                const nameSpan = document.createElement('span');
                nameSpan.textContent = form.name || 'æœªå‘½åè¡¨å•';

                const countSpan = document.createElement('span');
                countSpan.className = 'form-filter-count';
                const countValue = typeof form.count === 'number' ? form.count : 0;
                countSpan.textContent = `(${countValue})`;

                itemLabel.appendChild(checkbox);
                itemLabel.appendChild(badgeSpan);
                itemLabel.appendChild(nameSpan);
                itemLabel.appendChild(countSpan);

                fragment.appendChild(itemLabel);
            });

            listDiv.innerHTML = '';
            if (visibleCount === 0 && searchText) {
                listDiv.innerHTML = '<div class="loading">æœªæ‰¾åˆ°åŒ¹é…çš„æ•°æ®æº</div>';
            } else {
                listDiv.appendChild(fragment);
            }
        }

        function filterFormItems() {
            const searchInput = document.getElementById('formFilterSearch');
            if (!searchInput) {
                return;
            }
            const searchText = searchInput.value.trim();
            renderFilteredFormItems(searchText);
        }

        function onFormFilterAllChange(event) {
            if (!event || !event.target) {
                return;
            }

            if (event.target.checked) {
                selectedSearchFormIds.clear();
                const listDiv = document.getElementById('formFilterList');
                if (listDiv) {
                    listDiv.querySelectorAll('input[type="checkbox"]').forEach(cb => {
                        cb.checked = false;
                    });
                }
            }

            updateFormFilterSummary();
        }

        function updateFormFilterSummary() {
            const summarySpan = document.getElementById('formFilterSummary');
            const allCheckbox = document.getElementById('formFilterAll');
            if (!summarySpan) {
                return;
            }

            const totalForms = availableSearchForms.length;
            const totalDocs = availableSearchForms.reduce((sum, item) => {
                const value = item && typeof item.count === 'number' ? item.count : 0;
                return sum + value;
            }, 0);

            if (!allCheckbox || allCheckbox.checked || selectedSearchFormIds.size === 0) {
                summarySpan.textContent = `å…± ${totalForms} ä¸ªæ•°æ®æºï¼Œåˆè®¡ ${totalDocs} æ¡è®°å½•`;
                return;
            }

            const selectedDocs = availableSearchForms.reduce((sum, item) => {
                if (item && selectedSearchFormIds.has(item.id)) {
                    const value = typeof item.count === 'number' ? item.count : 0;
                    return sum + value;
                }
                return sum;
            }, 0);

            summarySpan.textContent = `å·²é€‰ ${selectedSearchFormIds.size} ä¸ªæ•°æ®æºï¼ŒåŒ…å« ${selectedDocs} æ¡è®°å½•`;
        }

        function refreshFormStats() {
            const searchInput = document.getElementById('searchInput');
            const query = searchInput ? searchInput.value.trim() : '';
            
            if (!query) {
                // å¦‚æœæ²¡æœ‰æœç´¢å…³é”®è¯ï¼Œåˆ·æ–°æ€»é‡ç»Ÿè®¡
                loadSearchForms();
                return;
            }
            
            // å¦‚æœæœ‰æœç´¢å…³é”®è¯ï¼Œè·å–æœç´¢ç»“æœç»Ÿè®¡
            const formIds = getActiveFormIds();
            const exactSearch = document.getElementById('exactSearchCheckbox').checked;
            const payload = {
                query: query,
                size: 10,
                from: 0,
                userId: currentUserId,
                exactSearch: exactSearch
            };
            if (formIds.length > 0) {
                payload.formIds = formIds;
            }
            
            updateSearchFormStats(payload);
        }

        function updateSearchFormStats(searchPayload) {
            const summarySpan = document.getElementById('formFilterSummary');
            if (summarySpan) {
                summarySpan.textContent = 'æ­£åœ¨ç»Ÿè®¡æœç´¢ç»“æœ...';
            }
            
            // æœç´¢åæ›´æ–°è¡¨å•ç»Ÿè®¡ï¼Œæ˜¾ç¤ºæ¯ä¸ªè¡¨å•çš„æœç´¢ç»“æœæ•°é‡
            fetch('/api/search/forms', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(searchPayload)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success && data.data) {
                    // æ›´æ–°æœç´¢ç»“æœè¡¨å•ç»Ÿè®¡
                    renderSearchFormFilters(data.data);
                } else {
                    // å¦‚æœæ²¡æœ‰æœç´¢ç»“æœï¼Œæ˜¾ç¤ºæç¤º
                    if (summarySpan) {
                        summarySpan.textContent = 'è¯¥æœç´¢æ¡ä»¶æ— åŒ¹é…çš„æ•°æ®æº';
                    }
                }
            })
            .catch(error => {
                console.warn('æ›´æ–°æœç´¢è¡¨å•ç»Ÿè®¡å¤±è´¥:', error);
                if (summarySpan) {
                    summarySpan.textContent = 'æ•°æ®æºç»Ÿè®¡åŠ è½½å¤±è´¥';
                }
            });
        }

        function getActiveFormIds() {
            const allCheckbox = document.getElementById('formFilterAll');
            if (!allCheckbox || allCheckbox.checked || selectedSearchFormIds.size === 0) {
                return [];
            }
            const totalForms = availableSearchForms.length;
            if (totalForms > 0 && selectedSearchFormIds.size >= totalForms) {
                return [];
            }
            return Array.from(selectedSearchFormIds);
        }

        // æ‰§è¡Œæœç´¢
        function performSearch(page = 0) {
            const query = document.getElementById('searchInput').value.trim();
            if (!query) {
                alert('è¯·è¾“å…¥æœç´¢å…³é”®è¯');
                return;
            }
            
            currentQuery = query;
            currentPage = page;
            
            const resultsDiv = document.getElementById('searchResults');
            resultsDiv.innerHTML = '<div class="loading">æœç´¢ä¸­...</div>';

            if (!currentUserId) {
                const message = 'ç¼ºå°‘ç”¨æˆ·IDï¼Œè¯·é€šè¿‡å¸¦æœ‰user_idå‚æ•°çš„é“¾æ¥è®¿é—®åå†æ‰§è¡Œæœç´¢ã€‚';
                resultsDiv.innerHTML = `<div class="error">${message}</div>`;
                alert(message);
                return;
            }
            
            const formIds = getActiveFormIds();
            const exactSearch = document.getElementById('exactSearchCheckbox').checked;
            const payload = {
                query: query,
                size: pageSize,
                from: page * pageSize,
                userId: currentUserId,
                exactSearch: exactSearch
            };
            if (formIds.length > 0) {
                payload.formIds = formIds;
            }

            fetch('/api/search/search', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(payload)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    displayResults(data.data);
                    // æœç´¢åä¸è‡ªåŠ¨æ›´æ–°è¡¨å•ç»Ÿè®¡ï¼Œä¿æŒæœç´¢é«˜é€Ÿ
                } else {
                    const extra = data.data && data.data.result ? data.data.result : '';
                    const message = extra || data.message || 'æœç´¢å¤±è´¥';
                    resultsDiv.innerHTML = `<div class="error">æœç´¢å¤±è´¥: ${message}</div>`;
                }
            })
            .catch(error => {
                console.error('Error:', error);
                resultsDiv.innerHTML = `<div class="error">æœç´¢è¯·æ±‚å¤±è´¥: ${error.message}</div>`;
            });
        }
        
        // æ˜¾ç¤ºæœç´¢ç»“æœ
        function displayResults(data) {
            const resultsDiv = document.getElementById('searchResults');
            const paginationDiv = document.getElementById('pagination');
            setDetailBaseUrl(data.detail_base_url);
            
            if (data.hits.length === 0) {
                const filterNote = data.filterMessage ? `<div style="background: #fff3cd; color: #856404; padding: 10px; border-radius: 4px; margin: 10px 0; border-left: 4px solid #ffc107;"><strong>æç¤ºï¼š</strong>${data.filterMessage}</div>` : '';
                resultsDiv.innerHTML = `<div class="loading">æ²¡æœ‰æ‰¾åˆ°ç›¸å…³ç»“æœ</div>${filterNote}`;
                paginationDiv.innerHTML = '';
                return;
            }
            
            const reviewNote = data.review_result ? `<div class="success">å…³é”®å­—å®¡æ ¸: ${data.review_result}</div>` : '';
            const filterNote = data.filterMessage ? `<div style="background: #fff3cd; color: #856404; padding: 10px; border-radius: 4px; margin: 10px 0; border-left: 4px solid #ffc107;"><strong>æç¤ºï¼š</strong>${data.filterMessage}</div>` : '';
            let html = `<h4>æœç´¢ç»“æœ (å…± ${data.total} æ¡)</h4>${reviewNote}${filterNote}`;
            
            data.hits.forEach(hit => {
                const datasetLabel = hit.sourceType === 'excel' ? 'æ‰€å±Excel' : 'æ‰€å±è¡¨å•';
                const tableInfo = hit.sourceType === 'excel' && hit.tableName ? ` | æ•°æ®è¡¨: ${hit.tableName}` : '';
                const detailUrl = buildDetailUrl(hit.formId, hit.recordId, hit.jumpUrl);
                const escapedDetailUrl = escapeForSingleQuotes(detailUrl);
                const detailLink = detailUrl ? `<a href="${detailUrl}" target="_blank" class="jump-link" title="æ‰“å¼€è¯¦æƒ…é¡µé¢">ğŸ”—</a>` : '';
                const detailButton = detailUrl ? `<button class="jump-btn" onclick="openFormDetail('${escapedDetailUrl}')">æŸ¥çœ‹è¯¦æƒ…</button>` : '';
                html += `
                    <div class="result-item">
                        <div class="result-header">
                            <div class="result-title">
                                ${getResultTitle(hit)}
                                ${detailLink}
                            </div>
                            <div class="result-score">åŒ¹é…åº¦: ${hit.score.toFixed(2)}</div>
                        </div>
                        <div class="result-meta">
                            ${datasetLabel}: ${hit.formName}${tableInfo}
                            ${detailButton}
                        </div>
                        <div class="result-content">
                            ${formatRecordData(hit.data, hit.highlight)}
                        </div>
                    </div>
                `;
            });
            
            resultsDiv.innerHTML = html;
            
            // æ˜¾ç¤ºåˆ†é¡µ
            displayPagination(data.total);
        }
        
        // è·å–æœç´¢ç»“æœæ ‡é¢˜
        function getResultTitle(hit) {
            const data = hit.data;

            if (hit.sourceType === 'excel') {
                const excelName = data['Excelåç§°'];
                if (excelName && excelName.toString().trim()) {
                    return excelName.toString().trim();
                }
            }
            
            // é¦–å…ˆå°è¯•ä½¿ç”¨åç«¯æ ‡è®°çš„ä¸»è¦å­—æ®µï¼ˆæŒ‰ä¼˜å…ˆçº§ï¼‰
            for (let i = 0; i < 6; i++) {  // æœ€å¤šæ£€æŸ¥å‰6ä¸ªä¸»è¦å­—æ®µ
                const primaryField = data['_primary_field_' + i];
                const primaryValue = data['_primary_value_' + i];
                
                if (primaryValue && primaryValue.toString().trim()) {
                    // å¦‚æœæ˜¯ç¬¬ä¸€ä¸ªå­—æ®µï¼ˆæœ€é‡è¦ï¼‰ï¼Œç›´æ¥ä½¿ç”¨
                    if (i === 0) {
                        return primaryValue.toString().trim();
                    }
                    
                    // å¯¹äºå…¶ä»–å­—æ®µï¼Œæ£€æŸ¥æ˜¯å¦æ˜¯æ ‡é¢˜ç±»å­—æ®µ
                    if (primaryField && isLikelyTitleField(primaryField)) {
                        return primaryValue.toString().trim();
                    }
                }
            }
            
            // å¦‚æœä¸»è¦å­—æ®µéƒ½ä¸åˆé€‚ï¼ŒæŒ‰ä¼ ç»Ÿæ–¹å¼æŸ¥æ‰¾æ ‡é¢˜å­—æ®µ
            const titleFields = [
                'èµ„äº§åç§°', 'åç§°', 'æ ‡é¢˜', 'å§“å', 'è®¾å¤‡åç§°', 'äº§å“åç§°', 
                'é¡¹ç›®åç§°', 'å·¥ä½œåç§°', 'ä»»åŠ¡åç§°', 'æ–‡æ¡£åç§°'
            ];
            
            for (const field of titleFields) {
                if (data[field] && data[field].toString().trim()) {
                    return data[field].toString().trim();
                }
            }
            
            // æœ€åå›é€€åˆ°è¡¨å•åç§°
            return hit.formName || 'æœªå‘½åè®°å½•';
        }
        
        // åˆ¤æ–­å­—æ®µæ˜¯å¦åƒæ ‡é¢˜å­—æ®µ
        function isLikelyTitleField(fieldName) {
            const titleKeywords = ['åç§°', 'æ ‡é¢˜', 'å§“å', 'è®¾å¤‡', 'äº§å“', 'é¡¹ç›®', 'å·¥ä½œ', 'ä»»åŠ¡', 'æ–‡æ¡£'];
            return titleKeywords.some(keyword => fieldName.includes(keyword));
        }
        
        // æ ¼å¼åŒ–è®°å½•æ•°æ®
        function formatRecordData(data, highlight) {
            let html = '<table style="width: 100%; border-collapse: collapse;">';
            
            // è¿‡æ»¤æ‰å†…éƒ¨å­—æ®µæ ‡è®°ï¼Œåªæ˜¾ç¤ºç”¨æˆ·æ•°æ®
            for (const [key, value] of Object.entries(data)) {
                // è·³è¿‡å†…éƒ¨å­—æ®µæ ‡è®°å’Œç©ºå€¼
                if (!value || key.startsWith('_primary_')) continue;
                
                let displayValue = value;
                
                // æ£€æŸ¥æ˜¯å¦æœ‰é«˜äº®ï¼ˆæ³¨æ„ï¼šé«˜äº®çš„keyå¯èƒ½æ˜¯åŸå§‹å­—æ®µåï¼‰
                if (highlight && highlight[key]) {
                    displayValue = highlight[key][0];
                }
                
                html += `
                    <tr style="border-bottom: 1px solid #eee;">
                        <td style="padding: 5px; font-weight: bold; width: 150px;">${key}:</td>
                        <td style="padding: 5px;">${displayValue}</td>
                    </tr>
                `;
            }
            
            html += '</table>';
            return html;
        }
        
        // æ˜¾ç¤ºåˆ†é¡µ
        function displayPagination(total) {
            const paginationDiv = document.getElementById('pagination');
            const totalPages = Math.ceil(total / pageSize);
            
            if (totalPages <= 1) {
                paginationDiv.innerHTML = '';
                return;
            }
            
            let html = '';
            
            // ä¸Šä¸€é¡µ
            if (currentPage > 0) {
                html += `<button class="page-btn" onclick="performSearch(${currentPage - 1})">ä¸Šä¸€é¡µ</button>`;
            }
            
            // é¡µç 
            const startPage = Math.max(0, currentPage - 2);
            const endPage = Math.min(totalPages - 1, currentPage + 2);
            
            for (let i = startPage; i <= endPage; i++) {
                html += `<button class="page-btn ${i === currentPage ? 'active' : ''}" onclick="performSearch(${i})">${i + 1}</button>`;
            }
            
            // ä¸‹ä¸€é¡µ
            if (currentPage < totalPages - 1) {
                html += `<button class="page-btn" onclick="performSearch(${currentPage + 1})">ä¸‹ä¸€é¡µ</button>`;
            }
            
            paginationDiv.innerHTML = html;
        }
        
        // åŠ è½½è¡¨å•åˆ—è¡¨
        function loadForms(page = 1, search = '') {
            currentFormsPage = page;
            currentFormsSearch = search;
            
            const formsDiv = document.getElementById('formsList');
            formsDiv.innerHTML = '<div class="loading">åŠ è½½ä¸­...</div>';
            
            const params = new URLSearchParams({
                page: page,
                page_size: 10
            });
            
            if (search) {
                params.append('search', search);
            }
            
            fetch(`/api/sync/forms?${params}`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    displayForms(data.data, data.pagination);
                } else {
                    formsDiv.innerHTML = `<div class="error">åŠ è½½å¤±è´¥: ${data.message}</div>`;
                }
            })
            .catch(error => {
                console.error('Error:', error);
                formsDiv.innerHTML = `<div class="error">åŠ è½½è¯·æ±‚å¤±è´¥: ${error.message}</div>`;
            });
        }
        
        // æœç´¢è¡¨å•
        function searchForms() {
            const search = document.getElementById('formSearchInput').value.trim();
            loadForms(1, search);
        }
        
        // æ˜¾ç¤ºè¡¨å•åˆ—è¡¨
        function displayForms(forms, pagination) {
            const formsDiv = document.getElementById('formsList');
            
            if (forms.length === 0) {
                formsDiv.innerHTML = '<div class="loading">æ²¡æœ‰æ‰¾åˆ°è¡¨å•</div>';
                displayFormsPagination(null);
                return;
            }
            
            let html = '';
            if (pagination) {
                html += `<div style="margin-bottom: 15px; color: #666;">
                    æ˜¾ç¤ºç¬¬ ${pagination.page} é¡µï¼Œå…± ${pagination.total_pages} é¡µï¼Œæ€»è®¡ ${pagination.total} ä¸ªè¡¨å•
                </div>`;
            }
            
            forms.forEach(form => {
                // ç¡®ä¿è¡¨å•IDä½œä¸ºå­—ç¬¦ä¸²å¤„ç†ï¼Œé¿å…JavaScriptå¤§æ•°ç²¾åº¦ä¸¢å¤±
                const formIdStr = String(form.id);
                html += `
                    <div class="form-item">
                        <div class="form-info">
                            <h4>${form.name}</h4>
                            <div class="form-meta">ID: ${formIdStr}</div>
                        </div>
                        <div class="form-actions">
                            <button class="btn-small btn-primary" onclick="syncForm('${formIdStr}', false)">å¢é‡åŒæ­¥</button>
                            <button class="btn-small btn-success" onclick="syncForm('${formIdStr}', true)">å…¨é‡åŒæ­¥</button>
                        </div>
                    </div>
                `;
            });
            
            formsDiv.innerHTML = html;
            displayFormsPagination(pagination);
        }
        
        // æ˜¾ç¤ºè¡¨å•åˆ†é¡µ
        function displayFormsPagination(pagination) {
            const paginationDiv = document.getElementById('formsPagination');
            
            if (!pagination || pagination.total_pages <= 1) {
                paginationDiv.innerHTML = '';
                return;
            }
            
            let html = '';
            
            // ä¸Šä¸€é¡µ
            if (pagination.has_prev) {
                html += `<button class="page-btn" onclick="loadForms(${pagination.page - 1}, '${currentFormsSearch}')">ä¸Šä¸€é¡µ</button>`;
            }
            
            // é¡µç 
            const startPage = Math.max(1, pagination.page - 2);
            const endPage = Math.min(pagination.total_pages, pagination.page + 2);
            
            for (let i = startPage; i <= endPage; i++) {
                html += `<button class="page-btn ${i === pagination.page ? 'active' : ''}" onclick="loadForms(${i}, '${currentFormsSearch}')">${i}</button>`;
            }
            
            // ä¸‹ä¸€é¡µ
            if (pagination.has_next) {
                html += `<button class="page-btn" onclick="loadForms(${pagination.page + 1}, '${currentFormsSearch}')">ä¸‹ä¸€é¡µ</button>`;
            }
            
            paginationDiv.innerHTML = html;
        }
        
        // åŒæ­¥å•ä¸ªè¡¨å•
        function syncForm(formId, fullSync) {
            const button = event.target;
            const originalText = button.textContent;
            button.disabled = true;
            button.textContent = 'åŒæ­¥ä¸­...';
            
            console.log('åŒæ­¥è¡¨å•ID:', formId, 'ç±»å‹:', typeof formId, 'å…¨é‡åŒæ­¥:', fullSync);
            
            fetch(`/api/sync/sync/${formId}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    full_sync: fullSync
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert(`åŒæ­¥æˆåŠŸ: ${data.message}`);
                } else {
                    alert(`åŒæ­¥å¤±è´¥: ${data.message}`);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert(`åŒæ­¥è¯·æ±‚å¤±è´¥: ${error.message}`);
            })
            .finally(() => {
                button.disabled = false;
                button.textContent = originalText;
            });
        }
        
        // åŒæ­¥æ‰€æœ‰è¡¨å•
        function syncAllForms() {
            if (!confirm('ç¡®å®šè¦åŒæ­¥æ‰€æœ‰è¡¨å•å—ï¼Ÿè¿™å¯èƒ½éœ€è¦ä¸€äº›æ—¶é—´ã€‚')) {
                return;
            }
            
            const button = event.target;
            const originalText = button.textContent;
            button.disabled = true;
            button.textContent = 'åŒæ­¥ä¸­...';
            
            fetch('/api/sync/sync/all', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    full_sync: true
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    let message = 'åŒæ­¥å®Œæˆ:\n';
                    data.results.forEach(result => {
                        message += `${result.form_name}: ${result.message}\n`;
                    });
                    alert(message);
                    loadForms(); // åˆ·æ–°è¡¨å•åˆ—è¡¨
                } else {
                    alert(`åŒæ­¥å¤±è´¥: ${data.message}`);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert(`åŒæ­¥è¯·æ±‚å¤±è´¥: ${error.message}`);
            })
            .finally(() => {
                button.disabled = false;
                button.textContent = originalText;
            });
        }
        
        // å¼‚æ­¥åŒæ­¥æ‰€æœ‰è¡¨å•
        function asyncSyncAllForms() {
            if (!confirm('ç¡®å®šè¦å¼‚æ­¥åŒæ­¥æ‰€æœ‰è¡¨å•å—ï¼Ÿ')) {
                return;
            }
            
            const button = event.target;
            const originalText = button.textContent;
            button.disabled = true;
            button.textContent = 'å¯åŠ¨ä¸­...';
            
            fetch('/api/sync/async/sync/all', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    full_sync: true
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // æ˜¾ç¤ºå¼‚æ­¥åŒæ­¥çŠ¶æ€é¢æ¿
                    document.getElementById('asyncSyncStatus').style.display = 'block';
                    
                    // å¼€å§‹SSEè¿æ¥è·å–å®æ—¶è¿›åº¦
                    startSseProgressTracking(data.task_id);
                    
                } else {
                    alert('å¯åŠ¨å¼‚æ­¥åŒæ­¥å¤±è´¥: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('å¯åŠ¨å¼‚æ­¥åŒæ­¥è¯·æ±‚å¤±è´¥: ' + error.message);
            })
            .finally(() => {
                button.disabled = false;
                button.textContent = originalText;
            });
        }
        
        // ä½¿ç”¨SSEè·Ÿè¸ªè¿›åº¦
        function startSseProgressTracking(taskId) {
            // å…³é—­ä¹‹å‰çš„è¿æ¥
            if (currentEventSource) {
                currentEventSource.close();
            }
            
            // å»ºç«‹SSEè¿æ¥
            currentEventSource = new EventSource('/api/sync/async/progress/' + taskId);
            
            currentEventSource.onopen = function(event) {
                console.log('SSEè¿æ¥å·²å»ºç«‹');
            };
            
            currentEventSource.addEventListener('progress', function(event) {
                try {
                    const data = JSON.parse(event.data);
                    updateAsyncSyncUI(data);
                } catch (e) {
                    console.error('è§£æSSEæ•°æ®å¤±è´¥:', e);
                }
            });
            
            currentEventSource.addEventListener('complete', function(event) {
                console.log('SSEè¿æ¥å®Œæˆ');
                currentEventSource.close();
                currentEventSource = null;
                
                // 3ç§’åéšè—çŠ¶æ€é¢æ¿
                setTimeout(() => {
                    document.getElementById('asyncSyncStatus').style.display = 'none';
                    loadForms(); // åˆ·æ–°è¡¨å•åˆ—è¡¨
                }, 3000);
            });
            
            currentEventSource.addEventListener('error', function(event) {
                console.error('SSEè¿æ¥é”™è¯¯');
                if (event.target.readyState === EventSource.CLOSED) {
                    console.log('SSEè¿æ¥å·²å…³é—­');
                } else {
                    console.error('SSEè¿æ¥å‘ç”Ÿé”™è¯¯:', event);
                }
            });
            
            currentEventSource.onerror = function(event) {
                console.error('SSEè¿æ¥å¼‚å¸¸:', event);
                if (currentEventSource.readyState === EventSource.CLOSED) {
                    currentEventSource = null;
                }
            };
        }
        
        // æ‰“å¼€è¡¨å•è¯¦æƒ…é¡µé¢
        function openFormDetail(jumpUrl) {
            if (jumpUrl) {
                window.open(jumpUrl, '_blank');
            }
        }
        
        // æ›´æ–°å¼‚æ­¥åŒæ­¥UI
        function updateAsyncSyncUI(status) {
            const progressBar = document.getElementById('progressBar');
            const messageDiv = document.getElementById('asyncSyncMessage');
            const detailsDiv = document.getElementById('asyncSyncDetails');
            
            // æ›´æ–°è¿›åº¦æ¡
            if (status.progress !== undefined) {
                progressBar.style.width = status.progress + '%';
            }
            
            // æ›´æ–°çŠ¶æ€æ¶ˆæ¯
            if (status.message) {
                messageDiv.textContent = status.message;
            }
            
            // æ›´æ–°è¯¦ç»†ä¿¡æ¯
            let details = '';
            if (status.status === 'running') {
                if (status.current_form && status.current_form !== 'null' && status.current_form !== '') {
                    details += 'å½“å‰è¡¨å•: ' + status.current_form + ' ';
                }
                if (status.current_index !== undefined && status.total_forms !== undefined) {
                    details += '(' + status.current_index + '/' + status.total_forms + ')';
                }
                if (status.elapsed_time !== undefined) {
                    details += ' è€—æ—¶: ' + status.elapsed_time + 'ç§’';
                }
            } else if (status.status === 'completed') {
                if (status.success_count !== undefined && status.total_forms !== undefined) {
                    details += 'æˆåŠŸ: ' + status.success_count + '/' + status.total_forms + ' ';
                }
                if (status.failure_count !== undefined && status.failure_count > 0) {
                    details += 'å¤±è´¥: ' + status.failure_count + ' ';
                }
                if (status.elapsed_time !== undefined) {
                    details += 'è€—æ—¶: ' + status.elapsed_time + 'ç§’';
                }
                progressBar.style.backgroundColor = '#28a745';
            } else if (status.status === 'failed') {
                details = 'ä»»åŠ¡å¤±è´¥';
                if (status.error) {
                    details += ': ' + status.error;
                }
                progressBar.style.backgroundColor = '#dc3545';
            }
            
            detailsDiv.textContent = details;
        }

        function uploadExcel() {
            const fileInput = document.getElementById('excelFileInput');
            const messageDiv = document.getElementById('excelImportMessage');
            if (!messageDiv) {
                return;
            }

            messageDiv.innerHTML = '';

            if (!fileInput || !fileInput.files || fileInput.files.length === 0) {
                messageDiv.innerHTML = '<div class="error">è¯·é€‰æ‹©è¦å¯¼å…¥çš„Excelæ–‡ä»¶</div>';
                return;
            }

            const formData = new FormData();
            formData.append('file', fileInput.files[0]);

            const cover = document.getElementById('excelCoverCheckbox').checked;
            formData.append('cover', cover);

            messageDiv.innerHTML = '<div class="loading">æ­£åœ¨å¯¼å…¥ï¼Œè¯·ç¨å€™...</div>';

            fetch('/api/excel/import', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const count = data.data && data.data.row_count ? data.data.row_count : 0;
                    messageDiv.innerHTML = `<div class="success">å¯¼å…¥æˆåŠŸï¼Œå·²å†™å…¥ ${count} è¡Œæ•°æ®</div>`;
                    fileInput.value = '';
                    loadExcelImports();
                } else {
                    messageDiv.innerHTML = `<div class="error">å¯¼å…¥å¤±è´¥: ${data.message}</div>`;
                }
            })
            .catch(error => {
                console.error('Excel import error', error);
                messageDiv.innerHTML = `<div class="error">å¯¼å…¥è¯·æ±‚å¤±è´¥: ${error.message}</div>`;
            });
        }

        function loadExcelImports() {
            const listDiv = document.getElementById('excelImportList');
            if (!listDiv) {
                return;
            }

            listDiv.innerHTML = '<div class="loading">åŠ è½½å¯¼å…¥è®°å½•...</div>';

            fetch('/api/excel/list')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        renderExcelImports(data.data || []);
                    } else {
                        listDiv.innerHTML = `<div class="error">åŠ è½½å¯¼å…¥è®°å½•å¤±è´¥: ${data.message}</div>`;
                    }
                })
                .catch(error => {
                    console.error('Load excel imports error', error);
                    listDiv.innerHTML = `<div class="error">åŠ è½½å¯¼å…¥è®°å½•å¤±è´¥: ${error.message}</div>`;
                });
        }

        function renderExcelImports(list) {
            const listDiv = document.getElementById('excelImportList');
            if (!listDiv) {
                return;
            }

            if (!list || list.length === 0) {
                listDiv.innerHTML = '<div class="loading">æš‚æœªå¯¼å…¥Excelæ•°æ®</div>';
                return;
            }

            let html = '';
            list.forEach(item => {
                const columns = item.columnLabels ? Object.values(item.columnLabels) : [];
                const columnPreview = columns.length > 0 ? columns.slice(0, 6).join('ã€') + (columns.length > 6 ? 'â€¦' : '') : 'æœªæ£€æµ‹åˆ°åˆ—ä¿¡æ¯';
                const importTime = formatDateTime(item.importTime || item.import_time);
                const sheetInfo = item.sheetName ? ` | å·¥ä½œè¡¨: ${item.sheetName}` : '';
                const displayName = item.displayName || item.tableName;

                html += `
                    <div class="form-item">
                        <div class="form-info">
                            <h4>${displayName}</h4>
                            <div class="form-meta">æ•°æ®åº“è¡¨: ${item.tableName} | ESç´¢å¼•: ${item.indexName}${sheetInfo}</div>
                            <div class="form-meta">æ•°æ®è¡Œæ•°: ${item.rowCount} | å¯¼å…¥æ—¶é—´: ${importTime || 'æœªçŸ¥'}</div>
                            <div class="form-meta">åˆ—: ${columnPreview}</div>
                        </div>
                        <div class="form-actions">
                            <button class="btn-small btn-danger" onclick="deleteExcelImport('${item.tableName}', '${displayName}')">åˆ é™¤</button>
                        </div>
                    </div>
                `;
            });

            listDiv.innerHTML = html;
        }

        function formatDateTime(value) {
            if (!value) {
                return '';
            }
            if (typeof value === 'string') {
                return value.replace('T', ' ').replace(/\.\d+/, '');
            }
            return value;
        }

        function deleteExcelImport(tableName, displayName) {
            if (!tableName) {
                alert('æ— æ•ˆçš„è¡¨å');
                return;
            }
            
            const confirmMessage = `ç¡®å®šè¦åˆ é™¤Excelå¯¼å…¥æ•°æ® "${displayName}" å—ï¼Ÿ\n\næ­¤æ“ä½œå°†åˆ é™¤ï¼š\n- æ•°æ®åº“è¡¨ï¼š${tableName}\n- ESç´¢å¼•å’Œæ‰€æœ‰ç›¸å…³æ•°æ®\n- å¯¼å…¥è®°å½•\n\næ­¤æ“ä½œä¸å¯æ¢å¤ï¼`;
            
            if (!confirm(confirmMessage)) {
                return;
            }
            
            const button = event.target;
            const originalText = button.textContent;
            button.disabled = true;
            button.textContent = 'åˆ é™¤ä¸­...';
            
            fetch(`/api/excel/${encodeURIComponent(tableName)}`, {
                method: 'DELETE',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('åˆ é™¤æˆåŠŸ');
                    loadExcelImports(); // åˆ·æ–°åˆ—è¡¨
                } else {
                    alert(`åˆ é™¤å¤±è´¥: ${data.message}`);
                }
            })
            .catch(error => {
                console.error('Delete excel import error', error);
                alert(`åˆ é™¤è¯·æ±‚å¤±è´¥: ${error.message}`);
            })
            .finally(() => {
                button.disabled = false;
                button.textContent = originalText;
            });
        }
        
        // é¡µé¢åŠ è½½æ—¶çš„å¤„ç†
        document.addEventListener('DOMContentLoaded', function() {
            initializeUserContext();

            // ç»‘å®šå›è½¦é”®æœç´¢
            document.getElementById('searchInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    performSearch();
                }
            });
            
            // ç»‘å®šè¡¨å•æœç´¢å›è½¦é”®
            document.getElementById('formSearchInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    searchForms();
                }
            });
            
            // ç»‘å®šå®¡æ ¸ç­–ç•¥æœç´¢å›è½¦é”®
            document.getElementById('reviewSearchInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    searchReviewPolicies();
                }
            });

            // ç»‘å®šè¡¨å•è¿‡æ»¤æœç´¢
            const formFilterSearch = document.getElementById('formFilterSearch');
            if (formFilterSearch) {
                formFilterSearch.addEventListener('input', filterFormItems);
                formFilterSearch.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        filterFormItems();
                    }
                });
            }

            const allCheckbox = document.getElementById('formFilterAll');
            if (allCheckbox) {
                allCheckbox.addEventListener('change', onFormFilterAllChange);
            }
            loadSearchForms();
            
            // é¡µé¢å¸è½½æ—¶å…³é—­SSEè¿æ¥
            window.addEventListener('beforeunload', function() {
                if (currentEventSource) {
                    currentEventSource.close();
                }
            });
        });

        // å®¡æ ¸ç­–ç•¥ç»´æŠ¤åŠŸèƒ½
        function loadReviewPolicies() {
            const listDiv = document.getElementById('reviewPoliciesList');
            if (!listDiv) {
                return;
            }
            
            listDiv.innerHTML = '<div class="loading">åŠ è½½å®¡æ ¸ç­–ç•¥...</div>';
            
            fetch('/api/review-policy/list')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        allReviewPolicies = data.data || [];
                        filteredReviewPolicies = [...allReviewPolicies];
                        renderReviewPolicies(filteredReviewPolicies);
                    } else {
                        listDiv.innerHTML = `<div class="error">åŠ è½½å®¡æ ¸ç­–ç•¥å¤±è´¥: ${data.message}</div>`;
                    }
                })
                .catch(error => {
                    console.error('Load review policies error', error);
                    listDiv.innerHTML = `<div class="error">åŠ è½½å®¡æ ¸ç­–ç•¥å¤±è´¥: ${error.message}</div>`;
                });
        }

        function renderReviewPolicies(policies) {
            const listDiv = document.getElementById('reviewPoliciesList');
            if (!listDiv) {
                return;
            }
            
            if (!policies || policies.length === 0) {
                listDiv.innerHTML = '<div class="loading">æš‚æ— æ•°æ®æº</div>';
                return;
            }
            
            let html = '';
            policies.forEach(policy => {
                const typeLabel = policy.sourceType === 'form' ? 'è¡¨å•' : 'Excel';
                const modeDisplay = policy.reviewModeDisplay || (policy.reviewMode === 'view_first' ? 'å…ˆçœ‹åå®¡' : 'å…ˆå®¡åçœ‹');
                const modeClass = policy.reviewMode === 'view_first' ? 'btn-primary' : 'btn-success';
                const createdTime = policy.createdAt ? formatDateTime(policy.createdAt) : 'æœªè®¾ç½®';
                
                html += `
                    <div class="form-item">
                        <div class="form-info">
                            <h4>
                                <label style="display: flex; align-items: center; gap: 8px;">
                                    <input type="checkbox" class="review-item-checkbox" 
                                           data-source-type="${policy.sourceType}" 
                                           data-source-id="${policy.sourceId}">
                                    <span class="form-filter-badge" style="background: ${policy.sourceType === 'excel' ? '#fff3cd' : '#e6f0ff'}; color: ${policy.sourceType === 'excel' ? '#8a6200' : '#2254b3'};">${typeLabel}</span>
                                    ${policy.sourceName}
                                </label>
                            </h4>
                            <div class="form-meta">æ•°æ®æºID: ${policy.sourceId}</div>
                            <div class="form-meta">å½“å‰ç­–ç•¥: <span class="${modeClass}">${modeDisplay}</span> | è®¾ç½®æ—¶é—´: ${createdTime}</div>
                        </div>
                        <div class="form-actions">
                            <select onchange="setReviewMode('${policy.sourceType}', '${policy.sourceId}', this.value)" 
                                    style="padding: 6px; border: 1px solid #ddd; border-radius: 4px;">
                                <option value="view_first" ${policy.reviewMode === 'view_first' ? 'selected' : ''}>å…ˆçœ‹åå®¡</option>
                                <option value="review_first" ${policy.reviewMode === 'review_first' ? 'selected' : ''}>å…ˆå®¡åçœ‹</option>
                            </select>
                        </div>
                    </div>
                `;
            });
            
            listDiv.innerHTML = html;
            
            // æ›´æ–°å…¨é€‰æ¡†çŠ¶æ€
            updateReviewSelectAllState();
        }

        function searchReviewPolicies() {
            const searchInput = document.getElementById('reviewSearchInput');
            const searchText = searchInput ? searchInput.value.trim().toLowerCase() : '';
            
            if (!searchText) {
                filteredReviewPolicies = [...allReviewPolicies];
            } else {
                filteredReviewPolicies = allReviewPolicies.filter(policy => 
                    policy.sourceName.toLowerCase().includes(searchText) ||
                    policy.sourceId.toLowerCase().includes(searchText)
                );
            }
            
            renderReviewPolicies(filteredReviewPolicies);
        }

        function setReviewMode(sourceType, sourceId, reviewMode) {
            fetch('/api/review-policy/set', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    sourceType: sourceType,
                    sourceId: sourceId,
                    reviewMode: reviewMode
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // åˆ·æ–°åˆ—è¡¨
                    loadReviewPolicies();
                } else {
                    alert('è®¾ç½®å®¡æ ¸ç­–ç•¥å¤±è´¥: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Set review mode error', error);
                alert('è®¾ç½®å®¡æ ¸ç­–ç•¥å¤±è´¥: ' + error.message);
            });
        }


        function toggleAllReviewSelection() {
            const selectAll = document.getElementById('reviewSelectAll');
            const checkboxes = document.querySelectorAll('.review-item-checkbox');
            
            checkboxes.forEach(checkbox => {
                checkbox.checked = selectAll.checked;
            });
        }

        function updateReviewSelectAllState() {
            const selectAll = document.getElementById('reviewSelectAll');
            const checkboxes = document.querySelectorAll('.review-item-checkbox');
            const checkedCount = document.querySelectorAll('.review-item-checkbox:checked').length;
            
            if (checkboxes.length === 0) {
                selectAll.checked = false;
                selectAll.indeterminate = false;
            } else if (checkedCount === checkboxes.length) {
                selectAll.checked = true;
                selectAll.indeterminate = false;
            } else if (checkedCount > 0) {
                selectAll.checked = false;
                selectAll.indeterminate = true;
            } else {
                selectAll.checked = false;
                selectAll.indeterminate = false;
            }
        }

        function batchSetReviewMode(reviewMode) {
            const checkedBoxes = document.querySelectorAll('.review-item-checkbox:checked');
            if (checkedBoxes.length === 0) {
                alert('è¯·å…ˆé€‰æ‹©è¦è®¾ç½®çš„æ•°æ®æº');
                return;
            }
            
            const modeDisplay = reviewMode === 'view_first' ? 'å…ˆçœ‹åå®¡' : 'å…ˆå®¡åçœ‹';
            if (!confirm(`ç¡®å®šè¦å°†æ‰€é€‰çš„ ${checkedBoxes.length} ä¸ªæ•°æ®æºè®¾ç½®ä¸º"${modeDisplay}"å—ï¼Ÿ`)) {
                return;
            }
            
            // æŒ‰æ•°æ®æºç±»å‹åˆ†ç»„
            const groups = { form: [], excel: [] };
            checkedBoxes.forEach(checkbox => {
                const sourceType = checkbox.dataset.sourceType;
                const sourceId = checkbox.dataset.sourceId;
                if (groups[sourceType]) {
                    groups[sourceType].push(sourceId);
                }
            });
            
            // æ‰¹é‡è®¾ç½®
            const requests = [];
            Object.keys(groups).forEach(sourceType => {
                if (groups[sourceType].length > 0) {
                    requests.push(
                        fetch('/api/review-policy/batch-set', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({
                                sourceType: sourceType,
                                reviewMode: reviewMode,
                                sourceIds: groups[sourceType]
                            })
                        })
                    );
                }
            });
            
            Promise.all(requests)
                .then(responses => Promise.all(responses.map(r => r.json())))
                .then(results => {
                    const failed = results.filter(r => !r.success);
                    if (failed.length === 0) {
                        alert('æ‰¹é‡è®¾ç½®æˆåŠŸ');
                        loadReviewPolicies();
                    } else {
                        const errors = failed.map(r => r.message).join('\n');
                        alert('éƒ¨åˆ†è®¾ç½®å¤±è´¥:\n' + errors);
                        loadReviewPolicies();
                    }
                })
                .catch(error => {
                    console.error('Batch set review mode error', error);
                    alert('æ‰¹é‡è®¾ç½®å¤±è´¥: ' + error.message);
                });
        }

        // æ·»åŠ å¤é€‰æ¡†å˜æ›´ç›‘å¬
        document.addEventListener('change', function(event) {
            if (event.target.classList.contains('review-item-checkbox')) {
                updateReviewSelectAllState();
            }
            if (event.target.classList.contains('dept-checkbox')) {
                cascadeSelectChildren(event.target.value, event.target.checked);
            }
        });

        document.addEventListener('click', function(event) {
            if (event.target.classList.contains('dept-toggle')) {
                const nodeId = event.target.dataset.nodeId;
                const node = document.querySelector(`.dept-node[data-node-id="${nodeId}"]`);
                if (node) {
                    node.classList.toggle('collapsed');
                    event.target.textContent = node.classList.contains('collapsed') ? '+' : '-';
                }
            }
        });

        // éƒ¨é—¨æƒé™ç®¡ç†åŠŸèƒ½
        let allDepartments = [];
        let allFormPermissions = [];
        let currentEditingForm = null;

        function loadFormPermissions() {
            const listDiv = document.getElementById('formPermissionsList');
            if (!listDiv) {
                return;
            }
            
            listDiv.innerHTML = '<div class="loading">åŠ è½½æƒé™é…ç½®...</div>';
            
            fetch('/api/form-department-permission/list')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        allFormPermissions = data.data || [];
                        renderFormPermissions(allFormPermissions);
                    } else {
                        listDiv.innerHTML = `<div class="error">åŠ è½½æƒé™é…ç½®å¤±è´¥: ${data.message}</div>`;
                    }
                })
                .catch(error => {
                    console.error('Load permissions error', error);
                    listDiv.innerHTML = `<div class="error">åŠ è½½æƒé™é…ç½®å¤±è´¥: ${error.message}</div>`;
                });
        }

        function renderFormPermissions(permissions) {
            const listDiv = document.getElementById('formPermissionsList');
            if (!listDiv) {
                return;
            }
            
            if (!permissions || permissions.length === 0) {
                listDiv.innerHTML = '<div class="loading">æš‚æ— æƒé™é…ç½®</div>';
                return;
            }
            
            let html = '';
            permissions.forEach(permission => {
                const statusClass = permission.allowAllDepartments ? 'all-access' : 'restricted';
                const statusText = permission.allowAllDepartments ? 'æ‰€æœ‰éƒ¨é—¨å¯è®¿é—®' : 'é™åˆ¶éƒ¨é—¨è®¿é—®';
                const departmentCount = permission.departments ? permission.departments.length : 0;
                const updateTime = permission.updateTime ? formatDateTime(permission.updateTime) : 'æœªè®¾ç½®';
                const sourceTypeLabel = permission.sourceType === 'excel' ? 'Excel' : 'è¡¨å•';
                const sourceTypeClass = permission.sourceType === 'excel' ? 'form-filter-badge' : 'form-filter-badge';
                const sourceBadgeStyle = permission.sourceType === 'excel' ? 'background: #fff3cd; color: #8a6200;' : 'background: #e6f0ff; color: #2254b3;';
                
                html += `
                    <div class="permission-item">
                        <div class="permission-header">
                            <div class="permission-form-name">
                                <span class="${sourceTypeClass}" style="${sourceBadgeStyle}">${sourceTypeLabel}</span>
                                ${permission.sourceName || 'æœªå‘½åæ•°æ®æº'}
                            </div>
                            <div class="permission-status ${statusClass}">${statusText}</div>
                        </div>
                        <div style="margin-bottom: 10px;">
                            <span style="color: #666; font-size: 14px;">æ•°æ®æºID: ${permission.sourceId}</span>
                            ${permission.updateTime ? ` | æœ€åæ›´æ–°: ${updateTime}` : ''}
                        </div>
                        ${permission.allowAllDepartments ? 
                            '<div style="color: #666; margin: 10px 0;">é»˜è®¤æ‰€æœ‰éƒ¨é—¨éƒ½å¯ä»¥è®¿é—®æ­¤æ•°æ®æº</div>' :
                            `<div>
                                <div style="margin: 10px 0; color: #666;">å¯è®¿é—®éƒ¨é—¨ (${departmentCount}ä¸ª):</div>
                                <div class="department-list">
                                    ${permission.departments.map(dept => 
                                        `<span class="department-tag">${dept.departmentName}</span>`
                                    ).join('')}
                                </div>
                            </div>`
                        }
                        <div class="permission-actions">
                            <button class="btn-small btn-primary" onclick="editSourcePermission('${permission.sourceType}', '${permission.sourceId}', '${permission.sourceName}')">ç¼–è¾‘æƒé™</button>
                            ${!permission.allowAllDepartments ? 
                                `<button class="btn-small btn-danger" onclick="removeSourcePermission('${permission.sourceType}', '${permission.sourceId}', '${permission.sourceName}')">ç§»é™¤é™åˆ¶</button>` : 
                                ''
                            }
                        </div>
                    </div>
                `;
            });
            
            listDiv.innerHTML = html;
        }

        function searchFormPermissions() {
            const searchInput = document.getElementById('permissionSearchInput');
            const keyword = searchInput ? searchInput.value.trim() : '';
            
            if (!keyword) {
                renderFormPermissions(allFormPermissions);
                return;
            }
            
            const filtered = allFormPermissions.filter(permission => 
                (permission.sourceName && permission.sourceName.toLowerCase().includes(keyword.toLowerCase())) ||
                (permission.departments && permission.departments.some(dept => 
                    dept.departmentName.toLowerCase().includes(keyword.toLowerCase())
                ))
            );
            
            renderFormPermissions(filtered);
        }

        function editSourcePermission(sourceType, sourceId, sourceName) {
            currentEditingForm = { type: sourceType, id: sourceId, name: sourceName };
            document.getElementById('modalFormName').textContent = sourceName;
            
            // åŠ è½½å½“å‰æƒé™é…ç½®
            fetch(`/api/form-department-permission/source/${sourceType}/${encodeURIComponent(sourceId)}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        const permission = data.data;
                        
                        // è®¾ç½®è®¿é—®æ¨¡å¼
                        const allModeRadio = document.querySelector('input[name="accessMode"][value="all"]');
                        const restrictedModeRadio = document.querySelector('input[name="accessMode"][value="restricted"]');
                        
                        if (permission.allowAllDepartments) {
                            allModeRadio.checked = true;
                            restrictedModeRadio.checked = false;
                        } else {
                            allModeRadio.checked = false;
                            restrictedModeRadio.checked = true;
                        }
                        
                        toggleAccessMode();
                        
                        // å¦‚æœæ˜¯é™åˆ¶æ¨¡å¼ï¼Œè®¾ç½®é€‰ä¸­çš„éƒ¨é—¨
                        if (!permission.allowAllDepartments) {
                            setTimeout(() => {
                                const selectedDeptIds = permission.departments.map(d => d.departmentId);
                                setSelectedDepartments(selectedDeptIds);
                            }, 100);
                        }
                        
                        // æ˜¾ç¤ºæ¨¡æ€æ¡†
                        document.getElementById('permissionModal').style.display = 'block';
                    } else {
                        alert('è·å–æƒé™é…ç½®å¤±è´¥: ' + data.message);
                    }
                })
                .catch(error => {
                    console.error('Get source permission error', error);
                    alert('è·å–æƒé™é…ç½®å¤±è´¥: ' + error.message);
                });
        }

        function removeSourcePermission(sourceType, sourceId, sourceName) {
            const sourceLabel = sourceType === 'excel' ? 'Excelæ•°æ®æº' : 'è¡¨å•';
            if (!confirm(`ç¡®å®šè¦ç§»é™¤${sourceLabel}"${sourceName}"çš„è®¿é—®é™åˆ¶å—ï¼Ÿ\n\nç§»é™¤åï¼Œæ‰€æœ‰éƒ¨é—¨éƒ½å¯ä»¥è®¿é—®æ­¤æ•°æ®æºã€‚`)) {
                return;
            }
            
            fetch(`/api/form-department-permission/source/${sourceType}/${encodeURIComponent(sourceId)}`, {
                method: 'DELETE'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('ç§»é™¤æˆåŠŸ');
                    loadFormPermissions();
                } else {
                    alert('ç§»é™¤å¤±è´¥: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Remove source permission error', error);
                alert('ç§»é™¤å¤±è´¥: ' + error.message);
            });
        }

        function toggleAccessMode() {
            const restrictedMode = document.querySelector('input[name="accessMode"][value="restricted"]').checked;
            const departmentSelection = document.getElementById('departmentSelection');
            
            if (restrictedMode) {
                departmentSelection.style.display = 'block';
                loadDepartmentsForModal();
            } else {
                departmentSelection.style.display = 'none';
            }
        }

        let departmentTreeData = [];
        const deptChildrenMap = new Map();
        let allDepartmentIds = [];

        function buildDepartmentMaps(nodes, parentId = null) {
            nodes.forEach(node => {
                if (!deptChildrenMap.has(node.id)) {
                    deptChildrenMap.set(node.id, []);
                }
                allDepartmentIds.push(node.id);
                if (parentId) {
                    if (!deptChildrenMap.has(parentId)) {
                        deptChildrenMap.set(parentId, []);
                    }
                    deptChildrenMap.get(parentId).push(node.id);
                }
                if (node.children && node.children.length) {
                    buildDepartmentMaps(node.children, node.id);
                }
            });
        }

        function loadDepartmentsForModal() {
            const selector = document.getElementById('departmentSelector');
            if (!selector) {
                return;
            }
            
            if (departmentTreeData.length > 0) {
                deptChildrenMap.clear();
                allDepartmentIds = [];
                buildDepartmentMaps(departmentTreeData);
                renderDepartmentTree(departmentTreeData);
                return;
            }
            
            selector.innerHTML = '<div class="loading">åŠ è½½éƒ¨é—¨åˆ—è¡¨...</div>';
            allDepartmentIds = [];
            
            fetch('/api/form-department-permission/departments/tree')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        departmentTreeData = Array.isArray(data.data) ? data.data : [];
                        deptChildrenMap.clear();
                        buildDepartmentMaps(departmentTreeData);
                        renderDepartmentTree(departmentTreeData);
                    } else {
                        selector.innerHTML = `<div class="error">åŠ è½½éƒ¨é—¨åˆ—è¡¨å¤±è´¥: ${data.message}</div>`;
                    }
                })
                .catch(error => {
                    console.error('Load department tree error', error);
                    selector.innerHTML = `<div class="error">åŠ è½½éƒ¨é—¨åˆ—è¡¨å¤±è´¥: ${error.message}</div>`;
                });
        }

        function renderDepartmentTree(treeData) {
            const selector = document.getElementById('departmentSelector');
            if (!selector) {
                return;
            }
            
            if (!treeData || treeData.length === 0) {
                selector.innerHTML = '<div class="loading">æœªæ‰¾åˆ°éƒ¨é—¨ä¿¡æ¯</div>';
                return;
            }
            
            const buildTree = (nodes) => {
                let html = '<ul class="dept-tree">';
                nodes.forEach(node => {
                    const hasChildren = node.children && node.children.length;
                    html += `
                        <li class="dept-node" data-node-id="${node.id}">
                            <div class="dept-node-header">
                                ${hasChildren ? `<button type="button" class="dept-toggle" data-node-id="${node.id}">-</button>` : '<span style="display:inline-block;width:16px;"></span>'}
                                <label>
                                    <input type="checkbox" class="dept-checkbox" value="${node.id}" id="dept_${node.id}">
                                    ${node.name} <span style="color:#999;font-size:12px;">(${node.type === 'Account' ? 'å•ä½' : 'éƒ¨é—¨'})</span>
                                </label>
                            </div>
                            ${hasChildren ? buildTree(node.children) : ''}
                        </li>
                    `;
                });
                html += '</ul>';
                return html;
            };

            selector.innerHTML = buildTree(treeData);
        }

        function setSelectedDepartments(selectedIds) {
            selectedIds.forEach(id => {
                const checkbox = document.getElementById(`dept_${id}`);
                if (checkbox) {
                    checkbox.checked = true;
                    cascadeSelectChildren(id, true);
                }
            });
        }

        function selectAllDepartments() {
            const checkboxes = document.querySelectorAll('#departmentSelector input[type="checkbox"]');
            checkboxes.forEach(checkbox => {
                checkbox.checked = true;
            });
        }

        function clearDepartmentSelection() {
            const checkboxes = document.querySelectorAll('#departmentSelector input[type="checkbox"]');
            checkboxes.forEach(checkbox => {
                checkbox.checked = false;
            });
        }

        function cascadeSelectChildren(id, checked) {
            const children = deptChildrenMap.get(id) || [];
            children.forEach(childId => {
                const childCheckbox = document.getElementById(`dept_${childId}`);
                if (childCheckbox) {
                    childCheckbox.checked = checked;
                }
                cascadeSelectChildren(childId, checked);
            });
        }

        function savePermissionConfig() {
            if (!currentEditingForm) {
                alert('æ— æ•ˆçš„è¡¨å•ä¿¡æ¯');
                return;
            }
            
            const allModeRadio = document.querySelector('input[name="accessMode"][value="all"]');
            let isAllAccess = allModeRadio.checked;
            
            let departmentIds = [];
            if (!isAllAccess) {
                const checkedBoxes = document.querySelectorAll('#departmentSelector input[type="checkbox"]:checked');
            departmentIds = Array.from(checkedBoxes).map(cb => cb.value);
                
                if (departmentIds.length === 0) {
                    alert('è¯·è‡³å°‘é€‰æ‹©ä¸€ä¸ªéƒ¨é—¨ï¼Œæˆ–è€…é€‰æ‹©"æ‰€æœ‰éƒ¨é—¨éƒ½å¯ä»¥è®¿é—®"');
                    return;
                }
            }
            
            if (!isAllAccess && departmentIds.length >= allDepartmentIds.length) {
                if (confirm('å·²é€‰æ‹©æ‰€æœ‰éƒ¨é—¨ï¼Œæ˜¯å¦æ”¹ä¸ºâ€œæ‰€æœ‰éƒ¨é—¨éƒ½å¯ä»¥è®¿é—®â€ï¼Ÿ')) {
                    isAllAccess = true;
                }
            }

            const payload = {
                sourceType: currentEditingForm.type,
                sourceId: currentEditingForm.id,
                departmentIds: isAllAccess ? [] : departmentIds,
                creatorId: currentUserId && !isNaN(parseInt(currentUserId, 10)) ? parseInt(currentUserId, 10) : null
            };
            
            fetch('/api/form-department-permission/save', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(payload)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('ä¿å­˜æˆåŠŸ');
                    closePermissionModal();
                    loadFormPermissions();
                } else {
                    alert('ä¿å­˜å¤±è´¥: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Save permission error', error);
                alert('ä¿å­˜å¤±è´¥: ' + error.message);
            });
        }

        function closePermissionModal() {
            document.getElementById('permissionModal').style.display = 'none';
            currentEditingForm = null;
            
            // é‡ç½®è¡¨å•
            document.querySelector('input[name="accessMode"][value="all"]').checked = true;
            document.querySelector('input[name="accessMode"][value="restricted"]').checked = false;
            document.getElementById('departmentSelection').style.display = 'none';
            clearDepartmentSelection();
        }

        // ç»‘å®šæƒé™æœç´¢å›è½¦é”®
        document.addEventListener('DOMContentLoaded', function() {
            const permissionSearchInput = document.getElementById('permissionSearchInput');
            if (permissionSearchInput) {
                permissionSearchInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        searchFormPermissions();
                    }
                });
            }
            
            // ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
            window.addEventListener('click', function(event) {
                const modal = document.getElementById('permissionModal');
                if (event.target === modal) {
                    closePermissionModal();
                }
            });
        });
    </script>
</body>
</html>
